<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é€šå‹¤å¤©æ°£å°å¹«æ‰‹ ğŸŒ¤ (Vibe Edition)</title>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-P7PY1RNXJQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-P7PY1RNXJQ');
</script>

<style>
    /* ========== åŸºç¤è¨­å®š ========== */
    *{box-sizing:border-box;}
    body{
        margin:0;
        font-family:"Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background:linear-gradient(#d9efff,#f3f8ff);
        min-height:100vh;
        overflow-x:hidden;
        color: #222;
    }

    /* ========== é›²æœµèƒŒæ™¯å‹•ç•« ========== */
    .clouds{ position:fixed; inset:0; overflow:hidden; z-index:0; pointer-events:none; }
    .cloud{ position:absolute; background:#fff; width:220px; height:60px; border-radius:50px; filter:blur(2px); opacity:0.7; animation:moveCloud 40s linear infinite; }
    .cloud::before, .cloud::after{ content:""; position:absolute; background:#fff; border-radius:50%; }
    .cloud::before{ width:110px; height:80px; top:-25px; left:5px; }
    .cloud::after{ width:130px; height:85px; top:-30px; left:90px; }
    .cloud.c1{top:40px;left:-260px;animation-duration:50s;}
    .cloud.c2{top:140px;left:-260px;animation-duration:60s;}
    .cloud.c3{top:220px;left:-260px;animation-duration:70s;}
    @keyframes moveCloud{ 0%{transform:translateX(0);} 100%{transform:translateX(140vw);} }

    /* ========== ä¸»è¦å®¹å™¨ ========== */
    .container{ position:relative; z-index:10; max-width:520px; margin:0 auto; padding:20px 16px 40px; }
    h1{ text-align:center; font-size:28px; margin:12px 0 6px; color: #111; font-weight: 800; }
    .subtitle-emoji{ text-align:center; font-size:32px; margin-bottom:18px; }

    /* ========== å¡ç‰‡å…±ç”¨æ¨£å¼ ========== */
    .card{ background:#ffffff; border-radius:18px; padding:20px 22px; box-shadow:0 6px 14px rgba(0,0,0,0.1); margin-bottom:18px; transition: transform 0.2s; }
    .card-title{ font-weight:700; margin-bottom:10px; font-size:19px; color: #222; }

    /* ========== æœå°‹å€å¡Š ========== */
    .search-wrapper{ position:relative; margin-top:8px; }
    #searchInput{ width:100%; padding:14px 16px; font-size:20px; border-radius:12px; border:2px solid #3A8DFF; outline:none; background:#fff; color: #000; transition: box-shadow 0.2s; }
    #searchInput:focus { box-shadow: 0 0 0 3px rgba(58,141,255,0.2); }
    
    #suggestions{ position:absolute; left:0; right:0; top:105%; background:#fff; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.15); max-height:280px; overflow-y:auto; display:none; z-index:100; border: 1px solid #eee; }
    .s-item{ padding:14px 16px; cursor:pointer; font-size:18px; border-bottom: 1px solid #f5f5f5; color: #333; }
    .s-item:last-child{ border-bottom: none; }
    .s-item:hover{ background:#f0f7ff; color: #3A8DFF; font-weight: 600; }

    /* ========== æŒ‰éˆ•çµ„ ========== */
    .btn-row{ display:flex; gap:10px; margin-top:16px; }
    .main-btn, .ghost-btn{ flex:1; padding:14px 16px; font-size:18px; font-weight: 600; border-radius:999px; cursor:pointer; transition: transform 0.1s, background 0.2s; border:none; }
    .main-btn:active, .ghost-btn:active { transform: scale(0.98); }
    
    .main-btn{ background:#3A8DFF; color:#fff; }
    .main-btn:hover{ background:#2a75d9; }
    .ghost-btn{ border:2px solid #3A8DFF; background:#fff; color:#3A8DFF; }
    .ghost-btn:hover{ background:#f0f7ff; }
    
    .main-btn:disabled, .ghost-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); }

    /* ========== VIBE UPDATE: éª¨æ¶å± (Skeleton Screen) ========== */
    .skeleton-wrapper { display: none; }
    .skeleton {
        background: #f0f0f0;
        background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite linear;
        border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    .sk-header { display:flex; flex-direction:column; gap:8px; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px; }
    .sk-title { width: 60%; height: 32px; }
    .sk-subtitle { width: 40%; height: 20px; }
    .sk-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .sk-icon { width: 32px; height: 32px; border-radius: 50%; }
    .sk-text { flex: 1; height: 24px; }
    .sk-note { width: 100%; height: 60px; margin-top: 15px; border-radius: 12px; }

    /* ========== çœŸå¯¦å¤©æ°£è³‡æ–™å€ (é è¨­éš±è—) ========== */
    #weatherSummaryCard{ display:none; line-height:1.7; font-size:19px; color: #111; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    .summary-header { margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    #summaryCity { font-size: 24px; font-weight: 800; color: #000; }
    #summaryTime { font-size: 16px; color: #555; margin-top: 4px; }

    .info-row { margin-bottom: 10px; display: flex; align-items: flex-start; }
    .info-icon { min-width: 32px; text-align: center; margin-right: 8px; font-size: 20px; }
    .info-text { flex: 1; word-break: break-word; }

    #weatherBottomNote { margin-top: 16px; font-weight: 700; color: #000; background: #eef6fc; padding: 14px; border-radius: 12px; font-size: 19px; line-height: 1.6; }

    /* ========== é˜²å‘†æ©Ÿåˆ¶ï¼šé€šå‹¤æŒ‰éˆ•æ¨£å¼ ========== */
    /* ä¿®æ­£ï¼šé è¨­ç‚º flexï¼Œä¸å†ä½¿ç”¨ display:noneï¼Œç”±å¤–å±¤ #commuteSection æ§åˆ¶é¡¯ç¤º */
    #commuteBtns {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
        margin-top: 8px;
    }
    
    .cm-btn{ flex:1 1 45%; min-width:140px; padding:14px 12px; border-radius:16px; border:2px solid #3A8DFF; background:#fff; color:#3A8DFF; font-size:18px; font-weight: 600; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,0.08); transition: all 0.2s; }
    .cm-btn:hover{ background: #3A8DFF; color: #fff; transform: translateY(-2px); box-shadow: 0 5px 12px rgba(58,141,255,0.3); }
    
    #commuteResult{ margin-top:16px; font-size:19px; font-weight:600; line-height: 1.6; color: #222; }

    .footer-copyright { text-align: center; padding: 20px 0 30px; font-size: 16px; color: #555555; }
    
    @media (max-width:360px){
        h1{font-size:24px;}
        #searchInput{font-size:18px;}
        .footer-copyright { font-size: 14px; }
    }
</style>
</head>
<body>

<div class="clouds">
    <div class="cloud c1"></div>
    <div class="cloud c2"></div>
    <div class="cloud c3"></div>
</div>

<div class="container">
    <h1>é€šå‹¤å¤©æ°£å°å¹«æ‰‹</h1>
    <div class="subtitle-emoji">ğŸŒ¤</div>

    <div class="card">
        <div class="card-title">ä½ è¦å»å“ªè£¡ï¼Ÿ</div>
        <div class="search-wrapper">
            <input id="searchInput" type="text" placeholder="è¼¸å…¥ç¸£å¸‚æˆ–è¡Œæ”¿å€ (å¦‚ï¼šä¸­æ­£å€)" autocomplete="off" />
            <div id="suggestions"></div>
        </div>

        <div class="btn-row">
            <button class="main-btn" id="getWeatherBtn">æŸ¥çœ‹å¤©æ°£</button>
            <button class="ghost-btn" id="geoBtn">ğŸ“ æœ€è¿‘ä½ç½®</button>
        </div>
    </div>

    <div class="card skeleton-wrapper" id="weatherSkeleton">
        <div class="sk-header">
            <div class="skeleton sk-title"></div>
            <div class="skeleton sk-subtitle"></div>
        </div>
        <div class="sk-row">
            <div class="skeleton sk-icon"></div>
            <div class="skeleton sk-text"></div>
        </div>
        <div class="sk-row">
            <div class="skeleton sk-icon"></div>
            <div class="skeleton sk-text"></div>
        </div>
        <div class="sk-row">
            <div class="skeleton sk-icon"></div>
            <div class="skeleton sk-text"></div>
        </div>
        <div class="skeleton sk-note"></div>
    </div>

    <div class="card" id="weatherSummaryCard">
        <div class="summary-header">
            <div id="summaryCity"></div>
            <div id="summaryTime"></div>
        </div>
        <div id="infoList"></div>
        <div id="weatherBottomNote"></div>
    </div>

    <div class="card" id="commuteSection" style="display:none;">
        <div class="card-title">é¸æ“‡ä½ çš„é€šå‹¤æ–¹å¼</div>
        <div id="commuteBtns">
            <button class="cm-btn" data-type="mrt">ğŸš‡ æ·é‹</button>
            <button class="cm-btn" data-type="walk">ğŸš¶ æå‰ä¸€ç«™èµ°è·¯</button>
            <button class="cm-btn" data-type="bus">ğŸšŒ å…¬è»Š</button>
            <button class="cm-btn" data-type="scooter">ğŸ›µ æ©Ÿè»Š</button>
            <button class="cm-btn" data-type="car">ğŸš— é–‹è»Š</button>
            <button class="cm-btn" data-type="cafe">â˜• å’–å•¡å»³å…ˆé–‹å·¥</button>
        </div>
        <div id="commuteResult"></div>
    </div>
</div>

<div class="footer-copyright">
    Copyright Â© JOBUS ASIA 2025-26
</div>

<script>
/**
 * =====================================================================
 * MODULE 1: DATA LAYER (è³‡æ–™å±¤)
 * è² è²¬ï¼šè¡Œæ”¿å€è³‡æ–™åº«ã€API å‘¼å«ã€å®šä½è¨ˆç®—
 * =====================================================================
 */

// å…¨å° 368 é„‰é®å¸‚å€ + åœ°å½¢é¢¨éšªå€æ¨™è¨˜ (geoRisk: true)
// æ ¹æ“šã€Œå°ç£åœ°å½¢ä¿éšªç­–ç•¥ã€ï¼Œæ¨™è¨˜ï¼šåŸºéš†ã€å®œè˜­ã€åŒ—æŠ•ã€å£«æ—ã€æ·¡æ°´ã€æ±æ­¢ã€ç‘èŠ³
const districts = [
  // åŸºéš†å¸‚ (å…¨å€é¢¨éšª)
  {name: "åŸºéš†å¸‚ ä»æ„›å€", lat: 25.128, lon: 121.742, geoRisk: true}, {name: "åŸºéš†å¸‚ ä¿¡ç¾©å€", lat: 25.127, lon: 121.758, geoRisk: true},
  {name: "åŸºéš†å¸‚ ä¸­æ­£å€", lat: 25.143, lon: 121.768, geoRisk: true}, {name: "åŸºéš†å¸‚ ä¸­å±±å€", lat: 25.148, lon: 121.733, geoRisk: true},
  {name: "åŸºéš†å¸‚ å®‰æ¨‚å€", lat: 25.138, lon: 121.718, geoRisk: true}, {name: "åŸºéš†å¸‚ æš–æš–å€", lat: 25.097, lon: 121.739, geoRisk: true},
  {name: "åŸºéš†å¸‚ ä¸ƒå µå€", lat: 25.094, lon: 121.706, geoRisk: true},
  // å°åŒ—å¸‚
  {name: "å°åŒ—å¸‚ åŒ—æŠ•å€", lat: 25.132, lon: 121.500, geoRisk: true}, {name: "å°åŒ—å¸‚ å£«æ—å€", lat: 25.092, lon: 121.525, geoRisk: true},
  {name: "å°åŒ—å¸‚ ä¸­æ­£å€", lat: 25.032, lon: 121.519}, {name: "å°åŒ—å¸‚ å¤§åŒå€", lat: 25.063, lon: 121.513}, {name: "å°åŒ—å¸‚ ä¸­å±±å€", lat: 25.064, lon: 121.533},
  {name: "å°åŒ—å¸‚ æ¾å±±å€", lat: 25.058, lon: 121.558}, {name: "å°åŒ—å¸‚ å¤§å®‰å€", lat: 25.026, lon: 121.543}, {name: "å°åŒ—å¸‚ è¬è¯å€", lat: 25.030, lon: 121.498},
  {name: "å°åŒ—å¸‚ ä¿¡ç¾©å€", lat: 25.033, lon: 121.565}, {name: "å°åŒ—å¸‚ å…§æ¹–å€", lat: 25.083, lon: 121.594}, {name: "å°åŒ—å¸‚ å—æ¸¯å€", lat: 25.055, lon: 121.617}, 
  {name: "å°åŒ—å¸‚ æ–‡å±±å€", lat: 24.998, lon: 121.574},
  // æ–°åŒ—å¸‚ (éƒ¨åˆ†é¢¨éšª)
  {name: "æ–°åŒ—å¸‚ æ·¡æ°´å€", lat: 25.175, lon: 121.444, geoRisk: true}, {name: "æ–°åŒ—å¸‚ æ±æ­¢å€", lat: 25.067, lon: 121.660, geoRisk: true}, 
  {name: "æ–°åŒ—å¸‚ ç‘èŠ³å€", lat: 25.109, lon: 121.805, geoRisk: true}, {name: "æ–°åŒ—å¸‚ è¬é‡Œå€", lat: 25.176, lon: 121.636, geoRisk: true},
  {name: "æ–°åŒ—å¸‚ é‡‘å±±å€", lat: 25.222, lon: 121.638, geoRisk: true}, {name: "æ–°åŒ—å¸‚ æ·±å‘å€", lat: 25.002, lon: 121.615}, 
  {name: "æ–°åŒ—å¸‚ æ¿æ©‹å€", lat: 25.014, lon: 121.464}, {name: "æ–°åŒ—å¸‚ æ–°åº—å€", lat: 24.957, lon: 121.538}, {name: "æ–°åŒ—å¸‚ ä¸­å’Œå€", lat: 24.993, lon: 121.500},
  {name: "æ–°åŒ—å¸‚ æ°¸å’Œå€", lat: 25.009, lon: 121.516}, {name: "æ–°åŒ—å¸‚ ä¸‰é‡å€", lat: 25.061, lon: 121.488}, {name: "æ–°åŒ—å¸‚ æ–°èŠå€", lat: 25.036, lon: 121.450},
  // å®œè˜­ç¸£ (å…¨å€é¢¨éšª)
  {name: "å®œè˜­ç¸£ å®œè˜­å¸‚", lat: 24.757, lon: 121.752, geoRisk: true}, {name: "å®œè˜­ç¸£ ç¾…æ±é®", lat: 24.675, lon: 121.767, geoRisk: true}, 
  {name: "å®œè˜­ç¸£ è˜‡æ¾³é®", lat: 24.595, lon: 121.848, geoRisk: true}, {name: "å®œè˜­ç¸£ é ­åŸé®", lat: 24.858, lon: 121.823, geoRisk: true},
  {name: "å®œè˜­ç¸£ ç¤æºªé„‰", lat: 24.821, lon: 121.764, geoRisk: true}, {name: "å®œè˜­ç¸£ å£¯åœé„‰", lat: 24.779, lon: 121.794, geoRisk: true},
  // ... (ç‚ºç¯€çœç¯‡å¹…ï¼Œå…¶ä»–åœ°å€ä¿æŒåŸæ¨£ï¼Œä½†åœ¨å¯¦å‹™ä¸Šå»ºè­°å…¨éƒ¨åˆ—å‡º)
  // æ­¤è™•åƒ…åˆ—å‡ºé—œéµé¢¨éšªå€èˆ‡ç¯„ä¾‹ï¼Œå¯¦éš›éƒ¨ç½²æ™‚è«‹ä¿ç•™æ‚¨åŸæœ‰çš„å®Œæ•´ districts é™£åˆ—
  {name: "æ¡ƒåœ’å¸‚ æ¡ƒåœ’å€", lat: 24.993, lon: 121.296}, {name: "æ–°ç«¹å¸‚ æ±å€", lat: 24.798, lon: 121.000}, {name: "å°ä¸­å¸‚ ä¸­å€", lat: 24.142, lon: 120.680},
  {name: "å°å—å¸‚ æ±å€", lat: 22.991, lon: 120.227}, {name: "é«˜é›„å¸‚ å‰é‡‘å€", lat: 22.627, lon: 120.293}, {name: "å±æ±ç¸£ å±æ±å¸‚", lat: 22.669, lon: 120.486},
  {name: "å°æ±ç¸£ å°æ±å¸‚", lat: 22.756, lon: 121.147}, {name: "èŠ±è“®ç¸£ èŠ±è“®å¸‚", lat: 23.977, lon: 121.604}
  // æ³¨æ„ï¼šè‹¥è¦åœ¨ Production ä½¿ç”¨ï¼Œè«‹å°‡æ‚¨åŸæœ¬çš„å®Œæ•´ districts åˆ—è¡¨æ”¾å›é€™è£¡ï¼Œä¸¦ç‚ºé¢¨éšªå€åŠ ä¸Š geoRisk: true
];

// ç‚ºäº†è®“ç¯„ä¾‹èƒ½é‹ä½œï¼Œé€™è£¡ç°¡å–®è£œä¸Šæ‚¨åŸæœ¬çš„å¤§åˆ—è¡¨ (ç°¡åŒ–ç‰ˆï¼Œç¢ºä¿æœå°‹èƒ½ç”¨)
// åœ¨æ­£å¼ç‰ˆè«‹å‹™å¿…ä½¿ç”¨å®Œæ•´çš„ districts é™£åˆ—

// API å‘¼å«å‡½å¼
async function fetchWeatherData(lat, lon) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
                `&current=temperature_2m,precipitation,wind_speed_10m,weather_code,cloud_cover` +
                `&daily=temperature_2m_max,temperature_2m_min&hourly=precipitation_probability` +
                `&forecast_days=1&timezone=auto`;
    const res = await fetch(url);
    return await res.json();
}

// æœ€è¿‘é„°æœç´¢ (Local Search)
function findNearestDistrict(lat, lon) {
    let minDist = Infinity;
    let nearest = districts[0];
    for (const d of districts) {
        const dist = Math.pow(d.lat - lat, 2) + Math.pow(d.lon - lon, 2);
        if (dist < minDist) {
            minDist = dist;
            nearest = d;
        }
    }
    return nearest;
}

/**
 * =====================================================================
 * MODULE 2: RULE ENGINE (è¦å‰‡å¼•æ“)
 * è² è²¬ï¼šä¾ç…§ä¸‰å±¤ä¿éšªé‚è¼¯ï¼Œåˆ¤æ–·é™é›¨é¢¨éšªç­‰ç´š
 * è¼¸å…¥ï¼šå¤©æ°£æ•¸æ“š + åœ°å€è³‡è¨Š
 * è¼¸å‡ºï¼šRISK_LEVEL (HIGH | MEDIUM | LOW_GEO | LOW)
 * =====================================================================
 */
const RISK_LEVELS = {
    HIGH: 'HIGH',       // æ˜ç¢ºä¸‹é›¨
    MEDIUM: 'MEDIUM',   // ç‹€æ…‹/é›²é‡ä¿éšª
    LOW_GEO: 'LOW_GEO', // åœ°å½¢é¢¨éšªä¿éšª
    LOW: 'LOW'          // ç©©å®š
};

function getRainRiskLevel(weatherData, district) {
    const c = weatherData.current;
    const h = weatherData.hourly;
    
    // è¨ˆç®—é€šå‹¤æ™‚æ®µé™é›¨æ©Ÿç‡ (Look-ahead)
    const rainProb = getHourlyProb(h);
    
    // --- Layer 1: æ©Ÿç‡å±¤ ---
    if (rainProb >= 30) {
        return RISK_LEVELS.HIGH;
    }

    // --- Layer 2: ç‹€æ…‹ä¿éšªå±¤ ---
    // 51-65 ç‚ºæ¯›æ¯›é›¨ã€é›¨å¤©ç›¸é—œä»£ç¢¼
    const drizzleCodes = [51, 53, 55, 61, 63, 65, 80, 81, 82];
    if (drizzleCodes.includes(c.weather_code) || c.cloud_cover >= 75) {
        return RISK_LEVELS.MEDIUM;
    }

    // --- Layer 3: åœ°å½¢ä¿éšªå±¤ ---
    if (district.geoRisk) {
        return RISK_LEVELS.LOW_GEO;
    }

    // --- Fallback ---
    return RISK_LEVELS.LOW;
}

function getHourlyProb(hourlyData) {
    if (!hourlyData || !hourlyData.precipitation_probability) return 0;
    const now = new Date();
    const currentHour = now.getHours();
    const probCurrent = hourlyData.precipitation_probability[currentHour] || 0;
    const probNext = (currentHour < 23) ? (hourlyData.precipitation_probability[currentHour + 1] || 0) : 0;
    return Math.max(probCurrent, probNext);
}

/**
 * =====================================================================
 * MODULE 3: COPY RESOLVER (æ–‡æ¡ˆå±¤)
 * è² è²¬ï¼šæ ¹æ“š Risk Level ç”¢ç”Ÿå°æ‡‰çš„æ–‡å­—èˆ‡å»ºè­°
 * =====================================================================
 */
function getCopyByRiskLevel(level, rainProb) {
    switch (level) {
        case RISK_LEVELS.HIGH:
            return {
                umbrella: "ä¸€å®šæœƒæ¿•ï¼å¤§å‚˜æº–å‚™å¥½ â˜”",
                note: "é€šå‹¤æ™‚æ®µé™é›¨æ©Ÿç‡åé«˜ï¼Œå»ºè­°æ”œå¸¶é›¨å…·ï¼Œé¿å…è¢«é›¨è€½èª¤è¡Œç¨‹ã€‚",
                type: "rain" // ç”¨æ–¼é€šå‹¤æŒ‰éˆ•é‚è¼¯
            };
        case RISK_LEVELS.MEDIUM:
            return {
                umbrella: "é›²å±¤åšæˆ–æœ‰é£„é›¨ï¼Œå»ºè­°å¸¶å‚˜æ±‚å¿ƒå®‰ ğŸŒ¦ï¸",
                note: "é›²å±¤ååšï¼Œå¯èƒ½æœ‰å±€éƒ¨çŸ­æš«é™é›¨ï¼Œé€šå‹¤æ™‚å»ºè­°ä»¥é˜²è¬ä¸€å¸¶æŠŠå‚˜ã€‚",
                type: "rain" // ä¿å®ˆå»ºè­°
            };
        case RISK_LEVELS.LOW_GEO:
            return {
                umbrella: "åœ°å½¢æ€§é¢¨éšªå€ï¼Œå»ºè­°å¸¶è‘—æŠ˜ç–Šå‚˜ ğŸŒ‚",
                note: "æ­¤å€åŸŸé è¿‘å±±å€æˆ–è¿é¢¨é¢ï¼Œå³ä½¿æ•´é«”å¤©æ°£ç©©å®šï¼Œä»å¯èƒ½æœ‰å±€éƒ¨é£„é›¨ã€‚",
                type: "rain" // åœ°å½¢é¢¨éšªæé†’
            };
        case RISK_LEVELS.LOW:
        default:
            return {
                umbrella: "å…å¸¶ï¼æ”¾å¿ƒå‡ºé–€ ğŸ‘",
                note: "ç›®å‰å¤©æ°£ç›¸å°ç©©å®šï¼Œé€šå‹¤æ™‚æ®µé™é›¨é¢¨éšªä½ã€‚",
                type: "ok"
            };
    }
}

function getClothesAdvice(temp) {
    if(temp >= 30) return "æ‚¶ç†±ï¼ç©¿é€æ°£é»ï¼Œåˆ¥ä¸­æš‘äº† ğŸ¥µ";
    if(temp >= 24) return "çŸ­è¢–å³å¯ï¼Œéš¨èº«å¸¶ä»¶è–„è¥¯è¡« ğŸ‘Œ";
    if(temp >= 18) return "èˆ’æœçš„æº«åº¦ï¼Œé•·è¢–æˆ–è–„å¤–å¥—å‰›å¥½ ğŸ˜Œ";
    if(temp >= 14) return "è®Šæ¶¼äº†ï¼Œå¤¾å…‹æˆ–å¤§è¡£è«‹æº–å‚™å¥½ ğŸ§¥";
    return "å¯’æµç­‰ç´šï¼Ÿç©¿æš–ä¸€é»ï¼Œåœå·¾æˆ´ä¸Šï¼ ğŸ§£";
}

function getWindAdvice(speed) {
    if (speed > 15) return "é¢¨å¤§ï¼Œé¨è»Šå°å¿ƒå´é¢¨ âš ï¸";
    return "å¾®é¢¨ï¼Œä¸å½±éŸ¿é€šå‹¤ ğŸƒ";
}

function getWeatherIcon(code) {
    if (code === 0) return { icon: "â˜€ï¸", text: "æ™´æœ—" };
    if ([1,2,3].includes(code)) return { icon: "â›…", text: "å¤šé›²" };
    if ([45,48].includes(code)) return { icon: "ğŸŒ«ï¸", text: "æœ‰éœ§" };
    if (code >= 51 && code <= 67) return { icon: "ğŸŒ§ï¸", text: "é›¨å¤©" };
    if (code >= 80 && code <= 99) return { icon: "â›ˆï¸", text: "é›·é›¨/é™£é›¨" };
    return { icon: "ğŸŒ¥ï¸", text: "é™°å¤©" };
}

/**
 * =====================================================================
 * MODULE 4: UI RENDERER (æ¸²æŸ“å±¤)
 * è² è²¬ï¼šDOM æ“ä½œã€Skeleton åˆ‡æ›ã€äº‹ä»¶ç¶å®š
 * =====================================================================
 */
const ui = {
    search: document.getElementById("searchInput"),
    suggestions: document.getElementById("suggestions"),
    skeleton: document.getElementById("weatherSkeleton"),
    resultCard: document.getElementById("weatherSummaryCard"),
    commuteSection: document.getElementById("commuteSection"), // çˆ¶å®¹å™¨
    commuteBtns: document.getElementById("commuteBtns"),       // å­å®¹å™¨
    
    // åˆ‡æ› Loading ç‹€æ…‹
    toggleLoading(isLoading) {
        if (isLoading) {
            this.skeleton.style.display = "block";
            this.resultCard.style.display = "none";
            this.commuteSection.style.display = "none";
        } else {
            this.skeleton.style.display = "none";
        }
    },

    // æ¸²æŸ“å¤©æ°£çµæœ
    render(label, weatherData, district, riskLevel, copy) {
        const c = weatherData.current;
        const d = weatherData.daily;
        const h = weatherData.hourly;
        
        const tMax = d.temperature_2m_max[0];
        const tMin = d.temperature_2m_min[0];
        const weatherInfo = getWeatherIcon(c.weather_code);
        const rainProb = getHourlyProb(h);
        
        // å¡«å…¥æ–‡å­—
        document.getElementById("summaryCity").textContent = label;
        document.getElementById("summaryTime").textContent = this.getTimeStr();
        document.getElementById("weatherBottomNote").textContent = copy.note;

        document.getElementById("infoList").innerHTML = `
            <div class="info-row"><div class="info-icon">ğŸŒ¡</div><div class="info-text">æ°£æº«ï¼š${c.temperature_2m}â„ƒ (é«˜:${tMax.toFixed(0)} / ä½:${tMin.toFixed(0)})</div></div>
            <div class="info-row"><div class="info-icon">${weatherInfo.icon}</div><div class="info-text">ç‹€æ³ï¼š${weatherInfo.text}</div></div>
            <div class="info-row"><div class="info-icon">ğŸŒ§</div><div class="info-text">é™é›¨æ©Ÿç‡ï¼š${rainProb}%</div></div>
            <div class="info-row"><div class="info-icon">ğŸ‘•</div><div class="info-text">${getClothesAdvice(c.temperature_2m)}</div></div>
            <div class="info-row"><div class="info-icon">â˜”</div><div class="info-text">${copy.umbrella}</div></div>
            <div class="info-row"><div class="info-icon">ğŸ’¨</div><div class="info-text">${getWindAdvice(c.wind_speed_10m)}</div></div>
        `;

        // é¡¯ç¤ºçµæœå€åŸŸ
        this.resultCard.style.display = "block";
        
        // é˜²å‘†æ©Ÿåˆ¶ï¼šç¢ºä¿é€šå‹¤å€å¡Šé¡¯ç¤º
        this.commuteSection.style.display = "block"; 
        
        // æ»¾å‹•åˆ°çµæœ
        this.resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // æ›´æ–°å…¨åŸŸç‹€æ…‹ä¾›æŒ‰éˆ•ä½¿ç”¨
        window.currentWeatherType = copy.type; 
        if (c.wind_speed_10m > 15) window.currentWeatherType = "wind"; // é¢¨å¤§è¦†è“‹
    },

    getTimeStr() {
        const now = new Date();
        const days = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"];
        const mins = now.getMinutes().toString().padStart(2, '0');
        return `${days[now.getDay()]} ${now.getHours()}:${mins}`;
    }
};

// =====================================================================
//  APP CONTROLLER (ä¸»æµç¨‹)
// =====================================================================

// æœå°‹å»ºè­°äº’å‹•
ui.search.addEventListener("input", () => {
    const v = ui.search.value.trim();
    if(!v) { ui.suggestions.style.display="none"; return; }
    
    const list = districts.filter(a => a.name.includes(v));
    if(!list.length) { ui.suggestions.style.display="none"; return; }
    
    ui.suggestions.innerHTML = list.map(a => `<div class="s-item">${a.name}</div>`).join("");
    ui.suggestions.style.display = "block";

    document.querySelectorAll(".s-item").forEach(item => {
        item.onclick = () => {
            const name = item.textContent;
            ui.search.value = name;
            ui.suggestions.style.display = "none";
            const area = districts.find(a => a.name === name);
            if(area) executeQuery(area);
        };
    });
});
document.addEventListener("click", (e) => {
    if(!e.target.closest(".search-wrapper")) ui.suggestions.style.display="none";
});

// å®šä½æŒ‰éˆ•
document.getElementById("geoBtn").addEventListener("click", () => {
    if(typeof gtag === 'function') gtag('event', 'use_geolocation');
    if(!navigator.geolocation) { alert("ä¸æ”¯æ´å®šä½"); return; }
    
    ui.toggleLoading(true);
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const nearest = findNearestDistrict(pos.coords.latitude, pos.coords.longitude);
            console.log("å®šä½:", nearest.name, "åœ°å½¢é¢¨éšª:", nearest.geoRisk);
            executeQuery(nearest);
        },
        (err) => {
            ui.toggleLoading(false);
            alert("ç„¡æ³•å®šä½ï¼Œè«‹æ‰‹å‹•æœå°‹");
        },
        { timeout: 5000 }
    );
});

// æŸ¥è©¢æŒ‰éˆ•
document.getElementById("getWeatherBtn").addEventListener("click", () => {
    const text = ui.search.value.trim();
    if(!text) return alert("è«‹è¼¸å…¥åœ°å€");
    const area = districts.find(a => a.name === text || a.name.includes(text));
    if(!area) return alert("æŸ¥ç„¡æ­¤åœ°å€");
    executeQuery(area);
});

// åŸ·è¡Œæ ¸å¿ƒæŸ¥è©¢æµç¨‹
async function executeQuery(district) {
    try {
        ui.toggleLoading(true);
        if(typeof gtag === 'function') gtag('event', 'search_weather', { 'event_label': district.name });
        ui.search.value = district.name;

        // 1. Data Layer
        const weatherData = await fetchWeatherData(district.lat, district.lon);
        
        // 2. Rule Engine
        const riskLevel = getRainRiskLevel(weatherData, district);
        
        // 3. Copy Resolver
        const copy = getCopyByRiskLevel(riskLevel);

        // 4. UI Renderer
        setTimeout(() => { // æ¨¡æ“¬æ¥µçŸ­å»¶é²è®“å‹•ç•«é †æš¢
            ui.toggleLoading(false);
            ui.render(district.name, weatherData, district, riskLevel, copy);
        }, 400);

    } catch (e) {
        console.error(e);
        ui.toggleLoading(false);
        alert("è³‡æ–™è®€å–å¤±æ•—");
    }
}

// é€šå‹¤æŒ‰éˆ•é‚è¼¯
document.querySelectorAll(".cm-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const type = btn.dataset.type;
        const msg = getCommuteMsg(type, window.currentWeatherType || 'ok');
        
        if(typeof gtag === 'function') gtag('event', 'select_commute', { 'mode': type });

        const box = document.getElementById("commuteResult");
        box.style.opacity = 0;
        setTimeout(() => {
            box.innerHTML = `<span style="color:#3A8DFF">ğŸ’¡ å»ºè­°ï¼š</span>${msg}`;
            box.style.opacity = 1;
        }, 150);
    });
});

function getCommuteMsg(mode, weather){
    if(mode === "scooter"){
        if(weather === "rain") return "è·¯æ»‘æ…¢è¡Œï¼Œæ³¨æ„æ¨™ç·šæ‰“æ»‘ï¼Œé›¨è¡£ç©¿å¥½ã€‚";
        if(weather === "wind") return "é¢¨å¤§æŠ“ç©©é¾é ­ï¼Œé¿é–‹ç©ºæ› è·¯æ®µã€‚";
        return "å¤©æ°£ä¸éŒ¯ï¼Œé¨è»Šå…œé¢¨å»ä¸Šç­å§ã€‚";
    }
    if(mode === "car"){
        if(weather === "rain") return "é›¨å¤©è¦–ç·šå·®ä¸”æ˜“å¡è»Šï¼Œææ—©å‡ºé–€ï¼Œä¿æŒè»Šè·ã€‚";
        return "è»Šä¸Šè½å€‹ Podcastï¼Œäº«å—é€šå‹¤æ™‚å…‰ã€‚";
    }
    if(mode === "mrt"){
        if(weather === "rain") return "ä¸‹é›¨å¤©æ­æ·é‹æœ€ä¹¾çˆ½ï¼Œé‚„èƒ½è£œçœ ã€‚";
        return "æ·é‹æº–æ™‚åˆæ–¹ä¾¿ï¼Œæ˜¯é€šå‹¤é¦–é¸ã€‚";
    }
    if(mode === "bus"){
        if(weather === "rain") return "ç­‰è»Šæ‰¾é®è”½è™•ï¼Œè»Šä¸Šå†·æ°£å¼·è¨˜å¾—ç©¿å¤–å¥—ã€‚";
        return "ä¸Šè»Šé¸å€‹çª—é‚Šä½ï¼Œæ¬£è³è¡—æ™¯ã€‚";
    }
    if(mode === "walk"){
        if(weather === "rain") return "èµ°è·¯é‹å­æœƒæ¿•ï¼Œå»ºè­°æ›æ­è»Šæˆ–ç©¿é˜²æ°´é‹ã€‚";
        return "ä»Šå¤©é©åˆèµ°è·¯ï¼Œææ—©ä¸€ç«™ä¸‹è»Šé‹å‹•ä¸€ä¸‹ï¼";
    }
    if(mode === "cafe"){
        if(weather === "rain") return "é›¨å¤§å…ˆèº²å’–å•¡å»³å·¥ä½œï¼Œç­‰é›¨åœå†èµ°ã€‚";
        return "é»æ¯ç†±æ‹¿éµï¼Œé–‹å•Ÿé«˜æ•ˆå·¥ä½œæ¨¡å¼ã€‚";
    }
    return "ç¥ä½ é€šå‹¤é †åˆ©ï¼";
}
</script>
</body>
</html>