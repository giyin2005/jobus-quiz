<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂøÉÁêÜÂÆáÂÆôÔºöMindverse</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700;900&family=Orbitron:wght@500;700;900&display=swap');

        /* ‚úÖ [iOS Fix] CSS ÈéñÂÆö */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            overscroll-behavior: none;
            background-color: #020205;
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: none;
            -webkit-font-smoothing: antialiased;
            position: fixed;
        }

        canvas {
            display: block;
        }
        
        .font-preload { position: absolute; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div class="font-preload" style="font-family: 'Orbitron'">Loading...</div>
    <div class="font-preload" style="font-family: 'Noto Sans TC'">Loading...</div>
    <canvas id="appCanvas"></canvas>

    <script>
        // --- Ê†∏ÂøÉÁ≥ªÁµ± ---
        const canvas = document.getElementById('appCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, dpr = 1, isMobile = false;
        
        // Ëº∏ÂÖ•ËàáÁãÄÊÖã
        let mouse = { x: 0, y: 0, down: false };
        let gyro = { x: 0, y: 0 };
        let currentScene = 'LOBBY'; 
        let activeGameId = null;
        let camera = { zoom: 1, x: 0, y: 0, targetZoom: 1, targetX: 0, targetY: 0 };
        let hitZones = []; 

        // --- Ë¶ñË¶∫È¢®Ê†ºÂÆöÁæ© ---
        const styles = {
            bg: '#020205',
            nodes: {
                'BIG5': { color: '#4d79ff', glow: '#00f3ff', type: 'pentagon', label: '‰∫îÂ§ßÊÄßÊ†º', desc: 'OCEAN Radar' },
                'MBTI': { color: '#ff3333', glow: '#ffcc00', type: 'core', label: 'RPG ËÅ∑Ê•≠', desc: 'Personality' },
                'ENNEAGRAM': { color: '#cd7f32', glow: '#ffd700', type: 'nonagon', label: '‰πùÂûã‰∫∫Ê†º', desc: 'Enneagram' },
                'RIASEC': { color: '#00ced1', glow: '#00ffcc', type: 'hexagon', label: 'Ëç∑Ëò≠‰ª£Á¢º', desc: 'Career Map' },
                'COLOR': { color: '#ff00ff', glow: '#ffffff', type: 'rainbow', label: 'Ëâ≤ÂΩ©ÂøÉÁêÜ', desc: 'Soul Aura' },
                'ANIMAL': { color: '#32cd32', glow: '#adff2f', type: 'radar', label: 'ÂãïÁâ©ÂúñÈ®∞', desc: 'Guardian' }
            }
        };

        // --- Ë≥áÊñôÂ∫´ ---
        const big5Data = {
            qs: [
                {t:"ÂñúÊ≠°Âú®ËÅöÊúÉ‰∏≠Ë™çË≠òÊñ∞ÊúãÂèã", k:'E'}, {t:"Â∞çËóùË°ìÂíåÊäΩË±°Ê¶ÇÂøµÊÑüËààË∂£", k:'O'}, {t:"ÂÅö‰∫ãÈÄöÂ∏∏ÊúÉÊèêÂâçË®àÂäÉ", k:'C'}, {t:"ÂÆπÊòìÊÑüÂèóÂà∞Âà•‰∫∫ÁöÑÊÉÖÁ∑í", k:'A'}, {t:"Â£ìÂäõÂ§ßÊôÇÂÆπÊòìÊÑüÂà∞ÁÑ¶ÊÖÆ", k:'N'}, {t:"ÊØîËºÉÂñúÊ≠°ÂÆâÈùúÁç®Ëôï", k:'E', rev:true}, {t:"ÂñúÊ≠°ÂòóË©¶Áï∞ÂúãÊñôÁêÜ", k:'O'}, {t:"ÊàøÈñìÈÄöÂ∏∏ÂæàÊï¥ÊΩî", k:'C'}, {t:"Ê®ÇÊñºÂπ´Âä©‰ªñ‰∫∫Ëß£Ê±∫ÂïèÈ°å", k:'A'}, {t:"ÊÉÖÁ∑íËµ∑‰ºèÊØîËºÉÂ§ß", k:'N'}
            ],
            results: { 'O':{t:"ÈñãÊîæÊÄß (Openness)", d:"‰Ω†ÂÖÖÊªøÊÉ≥ÂÉèÂäõÔºåÂñúÊ≠°ÂâµÊñ∞ËàáÂÜíÈö™„ÄÇ‰Ω†Â∞ç‰∏ñÁïåÂÖÖÊªøÂ•ΩÂ•áÔºå‰∏çÂñúÊ≠°‰∏ÄÊàê‰∏çËÆäÁöÑÁîüÊ¥ª„ÄÇ"}, 'C':{t:"Áõ°Ë≤¨ÊÄß (Conscientiousness)", d:"‰Ω†Ëá™Âæã‰∏îÁõÆÊ®ôÂ∞éÂêë„ÄÇÂÅö‰∫ã‰∫ï‰∫ïÊúâÊ¢ùÔºåÊòØÂúòÈöä‰∏≠ËÆì‰∫∫ÊúÄÊîæÂøÉÁöÑ‰∫∫„ÄÇ"}, 'E':{t:"Â§ñÂêëÊÄß (Extraversion)", d:"‰Ω†ÁÜ±ÊÉÖÊ¥ãÊ∫¢ÔºåÂñúÊ≠°Ëàá‰∫∫‰∫íÂãï„ÄÇÂú®Á§æ‰∫§Â†¥Âêà‰∏≠Ôºå‰Ω†Á∏ΩÊòØËÉΩÂ∏∂ÂãïÊ∞£Ê∞õ„ÄÇ"}, 'A':{t:"Ë¶™ÂíåÊÄß (Agreeableness)", d:"‰Ω†ÂØåÊúâÂêåÁêÜÂøÉÔºåÈáçË¶ñÂíåË´ß„ÄÇ‰Ω†ÂñÑÊñºÂÇæËÅΩÔºåÊòØÂ§ßÂÆ∂È°òÊÑèË®¥Ë™™ÂøÉ‰∫ãÁöÑÂ∞çË±°„ÄÇ"}, 'N':{t:"Á•ûÁ∂ìË≥™ (Neuroticism)", d:"‰Ω†ÊÉÖÊÑüË±êÂØåÔºåÂ∞çÁí∞Â¢ÉÊïèÊÑü„ÄÇÈõñÁÑ∂ÂÆπÊòìÁ∑äÂºµÔºå‰ΩÜ‰πüÂõ†Ê≠§ÊìÅÊúâÁ¥∞ËÜ©ÁöÑÂØüË¶∫Âäõ„ÄÇ"} }
        };
        const mbtiData = {
            qs: [{q:"ÈÄ±Êú´Êõ¥ÊÉ≥...", a:"Ë∑üÊúãÂèãÂá∫ÂéªÁé©(E)", b:"Âú®ÂÆ∂‰ºëÊÅØ(I)", d:'ei', v:2}, {q:"Â≠∏ÁøíÊñ∞‰∫ãÁâ©...", a:"ÂÖàÊáÇÁêÜË´ñ(N)", b:"ÂÖàÁúãÁØÑ‰æã(S)", d:'sn', v:2}, {q:"ÂÅöÊ±∫ÂÆöÊôÇ...", a:"ÈÇèËºØÂàÜÊûê(T)", b:"Âú®ÊÑèÊÑüÂèó(F)", d:'tf', v:2}, {q:"ÁîüÊ¥ªÊñπÂºè...", a:"ÊåâÈÉ®Â∞±Áè≠(J)", b:"Èö®ÈÅáËÄåÂÆâ(P)", d:'jp', v:2}, {q:"Ê¥æÂ∞ç‰∏ä...", a:"Ë™çË≠òÈôåÁîü‰∫∫(E)", b:"ÊâæÁÜü‰∫∫(I)", d:'ei', v:2}, {q:"‰Ω†Êõ¥Áõ∏‰ø°...", a:"Áõ¥Ë¶∫ËàáÈùàÊÑü(N)", b:"Á∂ìÈ©óËàáÊï∏Êìö(S)", d:'sn', v:2}, {q:"ÊúãÂèãË®¥Ëã¶...", a:"Áµ¶‰∫àÂª∫Ë≠∞(T)", b:"Áµ¶‰∫àÂÆâÊÖ∞(F)", d:'tf', v:2}, {q:"Â∑•‰ΩúÁí∞Â¢É...", a:"‰∫ïÁÑ∂ÊúâÂ∫è(J)", b:"ÂΩàÊÄßËá™Áî±(P)", d:'jp', v:2}],
            results: { 'ISTJ':{t:'ÁöáÂÆ∂Ë°õÂ£´',e:'üõ°Ô∏è',d:'‰∏ÄÁµ≤‰∏çËãüÁöÑÂü∑Ë°åËÄÖÔºåÈáçË¶ñÂÇ≥Áµ±ËàáÁß©Â∫è„ÄÇ'}, 'ISFJ':{t:'ÂÆàË≠∑Â§©‰Ωø',e:'üïØÔ∏è',d:'Ê∫´ÊöñËÄåÁõ°Ë≤¨ÔºåÈªòÈªòÂÆàË≠∑Ë∫´ÈÇäÁöÑ‰∫∫„ÄÇ'}, 'INFJ':{t:'Á•ûÁßòÂÖàÁü•',e:'üîÆ',d:'Ê¥ûÂØüÂäõÂº∑ÔºåÊìÅÊúâÊ∑±ÈÇÉÁöÑÁ≤æÁ•û‰∏ñÁïå„ÄÇ'}, 'INTJ':{t:'Êà∞Áï•ËªçÂ∏´',e:'‚ôüÔ∏è',d:'Áç®Á´ã‰∏îÂÖ∑ÈÅ†Ë¶ãÔºåËøΩÊ±ÇÊ•µËá¥ÁöÑÊïàÁéá„ÄÇ'}, 'ISTP':{t:'Â∑•Âå†Â§ßÂ∏´',e:'üîß',d:'ÂÜ∑ÈùúÁöÑËßÄÂØüËÄÖÔºåÊìÖÈï∑ÂãïÊâãËß£Ê±∫ÂïèÈ°å„ÄÇ'}, 'ISFP':{t:'ÈùàÈ≠ÇÁï´Â∏´',e:'üé®',d:'Ê∫´ÂíåÊïèÊÑüÔºåÁî®Ë°åÂãïË°®ÈÅîÊ∑±ÂàáÁöÑÊÉÖÊÑü„ÄÇ'}, 'INFP':{t:'Ê≤ªÁôíË©©‰∫∫',e:'üçÉ',d:'ÁêÜÊÉ≥‰∏ªÁæ©ËÄÖÔºåÂø†ÊñºËá™Â∑±ÁöÑÂÉπÂÄºËßÄ„ÄÇ'}, 'INTP':{t:'ÈÇèËºØÂ≠∏ÂÆ∂',e:'üß™',d:'Ê∏¥ÊúõÁü•Ë≠òÔºåÂñúÊ≠°Ëß£ÊßãË§áÈõúÁöÑÊ¶ÇÂøµ„ÄÇ'}, 'ESTP':{t:'Ê•µÈôêÂÜíÈö™ÂÆ∂',e:'üöÄ',d:'Ê¥ªÂú®Áï∂‰∏ãÔºåÂñúÊ≠°Ëß£Ê±∫ÁáÉÁúâ‰πãÊÄ•„ÄÇ'}, 'ESFP':{t:'Ë∂ÖÁ¥öÂ∑®Êòü',e:'üé§',d:'ÁîüÊ∞£ÂãÉÂãÉÔºåËÆìÁîüÊ¥ªÂÖÖÊªøÊ®ÇË∂£„ÄÇ'}, 'ENFP':{t:'ÁÜ±Ë°ÄÂ§¢ÊÉ≥ÂÆ∂',e:'üåà',d:'ÂÖÖÊªøÁÜ±ÊÉÖÔºåÁ∏ΩËÉΩÁúãË¶ãÁÑ°ÈôêÁöÑÂèØËÉΩÊÄß„ÄÇ'}, 'ENTP':{t:'ÂçöÂ≠∏ËæØË´ñÂÆ∂',e:'‚ö°',d:'Ê©üÊô∫ÈùàÊ¥ªÔºåÂñúÊ≠°ÊåëÊà∞Êô∫ÂäõÊ•µÈôê„ÄÇ'}, 'ESTJ':{t:'Â§ßÂÖÉÂ∏•',e:'‚öñÔ∏è',d:'ÊûúÊñ∑ÁöÑÁÆ°ÁêÜËÄÖÔºåÊìÖÈï∑ÁµÑÁπîËàáÊåáÊèÆ„ÄÇ'}, 'ESFJ':{t:'‰∫∫Ê∞£ÊîØÊü±',e:'ü§ù',d:'ÁÜ±ÂøÉÂä©‰∫∫ÔºåÈáçË¶ñÂúòÈöäÁöÑÂíåË´ßÊ∞õÂúç„ÄÇ'}, 'ENFJ':{t:'Á≤æÁ•ûÂ∞éÂ∏´',e:'üåª',d:'ÂÖÖÊªøÈ≠ÖÂäõÔºåÂñÑÊñºÊøÄÂãµ‰ªñ‰∫∫ÊàêÈï∑„ÄÇ'}, 'ENTJ':{t:'Â∏ùÂúãÁµ±Â∏•',e:'üëë',d:'Â§©ÁîüÁöÑÈ†òÂ∞éËÄÖÔºåËÉΩÁúãË¶ãÈï∑ÈÅ†ÁöÑÂ±ÄÂã¢„ÄÇ'} }
        };
        const ennData = {
            qs: [{q:"ÊúÄÂÆ≥ÊÄï...", a:"ÂÅöÈåØ‰∫ã(1)", b:"Ê≤í‰∫∫ÊÑõ(2)", ta:[1], tb:[2]}, {q:"Â∏åÊúõÂà•‰∫∫...", a:"ËÆöË≥ûÊàêÂ∞±(3)", b:"ÁêÜËß£Áç®Áâπ(4)", ta:[3], tb:[4]}, {q:"ÈÅáÂ£ìÂäõ...", a:"ÊäΩÈõ¢ÂàÜÊûê(5)", b:"Â∞ãÊ±ÇÂÆâÂÖ®(6)", ta:[5], tb:[6]}, {q:"ÁîüÊ¥ª...", a:"ËøΩÊ±ÇÂø´Ê®Ç(7)", b:"ÊéåÊéßÂ±ÄÈù¢(8)", ta:[7], tb:[8]}, {q:"‰∫∫Èöõ...", a:"ÈÅøÂÖçË°ùÁ™Å(9)", b:"ÊìöÁêÜÂäõÁà≠(8)", ta:[9], tb:[8]}, {q:"ÂÉπÂÄºËßÄ...", a:"Ê≠£Áõ¥ËàáÂéüÂâá(1)", b:"Èóú‰øÇËàáÈÄ£Áµê(2)", ta:[1], tb:[2]}, {q:"ÂãïÂäõ‰æÜÊ∫ê...", a:"ÊàêÂäüËàáÁõÆÊ®ô(3)", b:"Áç®ÁâπËàáÊÑèÁæ©(4)", ta:[3], tb:[4]}, {q:"Èù¢Â∞çÂïèÈ°å...", a:"Êî∂ÈõÜË≥áË®ä(5)", b:"Â∞ãÊ±ÇÁõüÂèã(6)", ta:[5], tb:[6]}, {q:"‰∫∫ÁîüËøΩÊ±Ç...", a:"Ëá™Áî±ËàáÈ´îÈ©ó(7)", b:"ÂíåÂπ≥ËàáÁ©©ÂÆö(9)", ta:[7], tb:[9]}],
            results: [null, {t:"ÊîπÈù©ËÄÖ(1)",d:"ËøΩÊ±ÇÂÆåÁæéËá™ÂæãÔºåÂ∏åÊúõËÉΩÊää‰∫ãÊÉÖÂÅöÂ∞ç„ÄÇ"}, {t:"Âä©‰∫∫ËÄÖ(2)",d:"Ê∫´ÊöñÊÖ∑ÊÖ®ÔºåÊ∏¥ÊúõË¢´ÊÑõÔºåÊ®ÇÊñº‰ªòÂá∫„ÄÇ‰Ω†ÂæàÂú®ÊÑè‰∫∫ÈöõÈóú‰øÇ„ÄÇ"}, {t:"ÊàêÂ∞±ËÄÖ(3)",d:"ÈÅ©ÊáâÂäõÂº∑ÔºåËøΩÊ±ÇÊàêÂäüÔºåÈáçË¶ñÂΩ¢Ë±°„ÄÇ‰Ω†ÊòØÁõÆÊ®ôÂ∞éÂêëÁöÑÈ´òÊïàËÉΩËÄÖ„ÄÇ"}, {t:"Ëá™ÊàëËÄÖ(4)",d:"Êµ™Êº´ÊïèÊÑüÔºåËøΩÊ±ÇÁç®ÁâπÔºåÊÉÖÊÑüË±êÂØå„ÄÇ‰Ω†ÊìÅÊúâÁç®ÁâπÁöÑÂØ©ÁæéËßÄ„ÄÇ"}, {t:"Ë™øÊü•Âì°(5)",d:"Ê±ÇÁü•ÊÖæÂº∑ÔºåÂñúÊ≠°ËßÄÂØüÔºåËºÉÁÇ∫ÈÄÄÁ∏Æ„ÄÇ‰Ω†ÂñúÊ≠°Ê∑±ÂÖ•Á†îÁ©∂‰∫ãÁâ©ÁöÑÊú¨Ë≥™„ÄÇ"}, {t:"Âø†Ë™†ËÄÖ(6)",d:"Ë≤†Ë≤¨Ë≠¶Ë¶∫ÔºåÈáçË¶ñÂÆâÂÖ®ÔºåÂ∞ãÊ±ÇÊåáÂºï„ÄÇ‰Ω†ÊòØÂúòÈ´î‰∏≠Âø†ÂØ¶ÁöÑÂÆàË≠∑ËÄÖ„ÄÇ"}, {t:"ÁÜ±ÊÉÖËÄÖ(7)",d:"Ê®ÇËßÄÂ§öÊâçÔºåËøΩÊ±ÇÂø´Ê®ÇÔºåË®éÂé≠ÊùüÁ∏õ„ÄÇ‰Ω†ÊòØÈªûÂ≠êÁéãÔºåÂñúÊ≠°Êñ∞ÈÆÆÊÑü„ÄÇ"}, {t:"ÊåëÊà∞ËÄÖ(8)",d:"Ëá™‰ø°ÊûúÊñ∑ÔºåÊÑèÂøóÂ†ÖÂº∑ÔºåÂñúÊ≠°ÊéåÊéß„ÄÇ‰Ω†ÊòØÂ§©ÁîüÁöÑÈ†òË¢ñÔºå‰øùË≠∑Ëá™Â∑±‰∫∫„ÄÇ"}, {t:"ÂíåÂπ≥ËÄÖ(9)",d:"Èö®ÂíåÂåÖÂÆπÔºåÈÅøÂÖçË°ùÁ™ÅÔºåÂ∞ãÊ±ÇÂíåË´ß„ÄÇ‰Ω†ÊòØÂæàÂ•ΩÁöÑÂÇæËÅΩËÄÖËàáË™øÂÅúËÄÖ„ÄÇ"}]
        };
        const riasecData = {
            qs: [{q:"‰øÆÁêÜÈõªÂô®",t:'R'}, {q:"ÂàÜÊûêÊï∏Êìö",t:'I'}, {q:"Áπ™Áï´Ë®≠Ë®à",t:'A'}, {q:"ÊïôÂ∞é‰ªñ‰∫∫",t:'S'}, {q:"Êé®Èä∑Áî¢ÂìÅ",t:'E'}, {q:"Êï¥ÁêÜÊñá‰ª∂",t:'C'}, {q:"Êìç‰ΩúÊ©üÊ¢∞",t:'R'}, {q:"Ëß£Ê±∫Êï∏Â≠∏È°å",t:'I'}, {q:"ÊºîÂ•èÊ®ÇÂô®",t:'A'}, {q:"ÁÖßÈ°ßÁóÖ‰∫∫",t:'S'}, {q:"Á´∂ÈÅ∏ÂππÈÉ®",t:'E'}, {q:"Âà∂ÂÆöË®àÁï´",t:'C'}],
            desc: { 'R':"ÂØ¶‰ΩúÂûã (R): ÂñúÊ≠°ÂãïÊâãÊìç‰ΩúÔºåÂãôÂØ¶„ÄÇ", 'I':"Á†îÁ©∂Âûã (I): ÂñúÊ≠°ÊÄùËÄÉÂàÜÊûêÔºåÁêÜÊÄß„ÄÇ", 'A':"ËóùË°ìÂûã (A): ÂñúÊ≠°Ââµ‰ΩúÔºåÁç®Áâπ„ÄÇ", 'S':"Á§æ‰∫§Âûã (S): ÂñúÊ≠°Ëàá‰∫∫‰∫íÂãïÔºåÁÜ±ÂøÉ„ÄÇ", 'E':"‰ºÅÊ•≠Âûã (E): ÂñúÊ≠°È†òÂ∞éË™™ÊúçÔºåËá™‰ø°„ÄÇ", 'C':"‰∫ãÂãôÂûã (C): ÂñúÊ≠°Ë¶èÂæãÔºåË¨πÊÖé„ÄÇ" }
        };
        const animalData = {
            qs: [{q:"ÁúãÈáç...", a:"ÁõÆÊ®ô(‰∫ã)", b:"Èóú‰øÇ(‰∫∫)", ax:'x', v:-1}, {q:"Ê≠•Ë™ø...", a:"Âø´", b:"ÊÖ¢", ax:'y', v:-1}, {q:"ÈÅáÂïèÈ°å...", a:"Áõ¥Êé•Ëß£Ê±∫", b:"Â∞ãÊ±ÇÂÖ±Ë≠ò", ax:'x', v:-1}, {q:"ÂúòÈ´î‰∏≠...", a:"‰∏ªÂ∞éÁôºË®Ä", b:"ÂÇæËÅΩÈÖçÂêà", ax:'y', v:-1}],
            results: { 'D':{t:"ËÄÅËôé (ÊîØÈÖçÂûã)", e:"üêØ", d:"ÁõÆÊ®ôÂ∞éÂêëÔºåÂ§©ÁîüÁöÑÈ†òÂ∞éËÄÖ„ÄÇÊûúÊñ∑‰∏îËá™‰ø°„ÄÇ"}, 'I':{t:"Â≠îÈõÄ (ÂΩ±ÈüøÂûã)", e:"ü¶ö", d:"ÁÜ±ÊÉÖÊ¥ãÊ∫¢ÔºåÁ§æ‰∫§ÁöÑÁÑ¶Èªû„ÄÇÊ®ÇËßÄ‰∏îÊúâË™™ÊúçÂäõ„ÄÇ"}, 'S':{t:"ÁÑ°Â∞æÁÜä (Á©©ÂÅ•Âûã)", e:"üê®", d:"Ê∫´ÂíåÂèãÂñÑÔºåÂèØÈù†ÁöÑÂ§•‰º¥„ÄÇÈáçË¶ñÂíåË´ßËàáÁ©©ÂÆö„ÄÇ"}, 'C':{t:"Ë≤ìÈ†≠È∑π (ÂàÜÊûêÂûã)", e:"ü¶â", d:"Á≤æÊ∫ñÂö¥Ë¨πÔºåÈÇèËºØÁöÑËøΩÊ±ÇËÄÖ„ÄÇÁ¥∞ÂøÉ‰∏îËøΩÊ±ÇÂÆåÁæé„ÄÇ"} }
        };
        const colorMeanings = { 4:"Ê∏¥ÊúõË°åÂãïËàáÂæÅÊúçÔºåÂÖÖÊªøÊ¥ªÂäõ„ÄÇ", 5:"ÂöÆÂæÄÊú™‰æÜÁöÑÂ∏åÊúõÔºåËøΩÊ±ÇÂø´Ê®Ç„ÄÇ", 3:"Â†ÖÊåÅ‰ø°ÂøµËàáËá™Â∞äÔºåË≠âÊòéÂÉπÂÄº„ÄÇ", 2:"Ê∏¥ÊúõÂπ≥ÈùúËàáÂÆâÂØßÔºåÈáçË¶ñÊÉÖÊÑü„ÄÇ", 6:"ÂÖÖÊªøÂπªÊÉ≥ÔºåËøΩÊ±ÇÁ•ûÁßòËàáÁ≤æÁ•û„ÄÇ", 7:"ÈáçË¶ñÊÑüÂÆò‰∫´ÂèóÔºåËøΩÊ±ÇËàíÈÅ©„ÄÇ", 1:"ÊÉ≥ËàáÂ§ñÁïå‰øùÊåÅË∑ùÈõ¢ÔºåÂ∞ãÊ±Ç‰øùË≠∑„ÄÇ", 8:"ÊäóÊãíÂ£ìÂäõÔºåË°®ÁèæÂá∫ÂÄîÂº∑„ÄÇ" };

        const lobbyNodes = [ { id: 'BIG5', active: true }, { id: 'MBTI', active: true }, { id: 'ENNEAGRAM', active: true }, { id: 'RIASEC', active: true }, { id: 'COLOR', active: true }, { id: 'ANIMAL', active: true } ];
        lobbyNodes.forEach(n => Object.assign(n, styles.nodes[n.id]));

        let gameSt = { big5: {idx:0, ans:3, scores:{O:0,C:0,E:0,A:0,N:0}, done:false}, mbti: {idx:0, scores:{ei:0,sn:0,tf:0,jp:0}, done:false}, enn: {idx:0, scores:new Array(10).fill(0), done:false}, riasec: {idx:0, scores:{R:0,I:0,A:0,S:0,E:0,C:0}, anim:{R:0,I:0,A:0,S:0,E:0,C:0}, done:false}, color: {phase:0, sel:[], auraT:0, done:false}, animal: {idx:0, pos:{x:0, y:0}, parts:[], done:false} };

        // --- Init ---
        function getSafeHeight() { return window.visualViewport ? window.visualViewport.height : window.innerHeight; }
        function init() {
            dpr = window.devicePixelRatio || 1;
            width = window.visualViewport ? window.visualViewport.width : window.innerWidth;
            height = getSafeHeight();
            canvas.style.width = width + "px"; canvas.style.height = height + "px";
            canvas.width = width * dpr; canvas.height = height * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            isMobile = width < 768;
            initStars();
        }

        const stars = []; const shootingStars = [];
        function initStars() { stars.length = 0; for(let i=0; i<150; i++) stars.push({ x: Math.random()*width, y: Math.random()*height, z: Math.random()*2+0.5, size: Math.random()*1.5, alpha: Math.random() }); }
        class ShootingStar { constructor(){this.reset();} reset(){this.x=Math.random()*width;this.y=Math.random()*height*0.5;this.len=Math.random()*80+20;this.speed=Math.random()*15+10;this.size=Math.random()*2;this.angle=Math.PI/4;this.active=true;this.life=1;} update(){this.x-=this.speed;this.y+=this.speed;this.life-=0.02;if(this.x<-100||this.y>height+100||this.life<=0)this.active=false;} draw(){if(!this.active)return;const tx=this.x+this.len*Math.cos(this.angle);const ty=this.y-this.len*Math.sin(this.angle);const g=ctx.createLinearGradient(this.x,this.y,tx,ty);g.addColorStop(0,'rgba(255,255,255,'+this.life+')');g.addColorStop(1,'rgba(255,255,255,0)');ctx.strokeStyle=g;ctx.lineWidth=this.size;ctx.beginPath();ctx.moveTo(this.x,this.y);ctx.lineTo(tx,ty);ctx.stroke();} }

        window.addEventListener("resize", () => setTimeout(init, 150));
        window.addEventListener('deviceorientation', (e) => { if(e.gamma && e.beta) { gyro.x = e.gamma * 2; gyro.y = (e.beta - 45) * 2; } });
        const getPos = (e) => { const r = canvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; };
        
        const handleInput = (x, y, isClick) => {
            if(isClick) mouse.down = true; mouse.x = x; mouse.y = y;
            let worldX = x, worldY = y;
            if (currentScene === 'LOBBY') { worldX = (x - width/2) / camera.zoom + width/2 + camera.x; worldY = (y - height/2) / camera.zoom + height/2 + camera.y; }
            let found = false;
            for (let z of hitZones) {
                let hit = false;
                if (z.t === 'circle') hit = Math.hypot(worldX - z.x, worldY - z.y) < z.r; else hit = (worldX >= z.x && worldX <= z.x+z.w && worldY >= z.y && worldY <= z.y+z.h);
                if (hit) { document.body.style.cursor = 'pointer'; found = true; if (isClick && z.action) { z.action(worldX); return; } }
            }
            if(!found) document.body.style.cursor = 'default';
        };

        canvas.addEventListener('mousemove', e => { const p=getPos(e); handleInput(p.x, p.y, false); });
        canvas.addEventListener('mousedown', e => { const p=getPos(e); handleInput(p.x, p.y, true); });
        canvas.addEventListener('mouseup', () => mouse.down=false);
        canvas.addEventListener('touchmove', e => { e.preventDefault(); const p=getPos(e.touches[0]); handleInput(p.x, p.y, false); }, {passive:false});
        canvas.addEventListener('touchstart', e => { e.preventDefault(); const p=getPos(e.touches[0]); handleInput(p.x, p.y, true); }, {passive:false});

        // --- Loop ---
        function loop() {
            camera.zoom += (camera.targetZoom - camera.zoom)*0.05; camera.x += (camera.targetX - camera.x)*0.05; camera.y += (camera.targetY - camera.y)*0.05;
            ctx.clearRect(0,0,width,height); hitZones=[];
            
            drawStars();

            if(currentScene==='LOBBY'||currentScene==='TRANSITION') {
                ctx.save(); ctx.translate(width/2, height/2); ctx.scale(camera.zoom, camera.zoom); ctx.translate(-width/2-camera.x, -height/2-camera.y);
                drawLobby(); ctx.restore();
                // Draw Footer in Screen Space
                if(camera.zoom < 1.5) {
                    ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.font='12px Orbitron'; ctx.textAlign='center';
                    ctx.fillText("Copyright ¬© JOBUS ASIA 2025", width/2, height-20);
                }
            } else {
                if(currentScene==='BIG5') drawBig5(); else if(currentScene==='MBTI') drawMBTI(); else if(currentScene==='ENNEAGRAM') drawEnneagram();
                else if(currentScene==='RIASEC') drawRIASEC(); else if(currentScene==='COLOR') drawColorTest(); else if(currentScene==='ANIMAL') drawAnimalTest();
            }
            requestAnimationFrame(loop);
        }

        function drawStars() {
            ctx.fillStyle = styles.bg; ctx.fillRect(0,0,width,height);
            if(Math.random() < 0.03) shootingStars.push(new ShootingStar());
            stars.forEach(s => {
                const offX = (mouse.x - width/2) * 0.02 * s.z + gyro.x;
                const offY = (mouse.y - height/2) * 0.02 * s.z + gyro.y;
                ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
                ctx.beginPath(); ctx.arc(s.x + offX, s.y + offY, s.size, 0, Math.PI*2); ctx.fill();
            });
            for(let i=shootingStars.length-1; i>=0; i--) {
                const s = shootingStars[i]; s.update(); s.draw();
                if(!s.active) shootingStars.splice(i, 1);
            }
        }

        // --- LOBBY ---
        let lobbyRot = 0;
        function drawLobby() {
            lobbyRot += 0.0005; const cx=width/2, cy=height/2;
            // [FIX] Increased radius to restore breathing room (0.35 mobile / 0.32 desktop)
            const r = Math.min(width, height) * (isMobile ? 0.35 : 0.32); 

            drawCentralStar(cx, cy);

            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.strokeStyle='rgba(255,255,255,0.05)'; ctx.lineWidth=1; ctx.stroke();
            lobbyNodes.forEach((node, i) => {
                const ang=(i/6)*Math.PI*2+lobbyRot; const nx=cx+Math.cos(ang)*r; const ny=cy+Math.sin(ang)*r;
                const wx=(mouse.x-width/2)/camera.zoom+width/2+camera.x; const wy=(mouse.y-height/2)/camera.zoom+height/2+camera.y;
                const hover=Math.hypot(wx-nx, wy-ny)<70; drawPlanetIcon(node, nx, ny, hover);
                if(camera.zoom<2) hitZones.push({t:'circle', x:nx, y:ny, r:70, action:()=>enterGame(node.id, nx, ny)});
            });
        }

        function drawCentralStar(cx, cy) {
            const p = Math.sin(Date.now()*0.003)*10;
            const g = ctx.createRadialGradient(cx, cy, 20, cx, cy, 100+p); g.addColorStop(0,'rgba(255,255,255,0.8)'); g.addColorStop(0.2,'#ff0055'); g.addColorStop(0.6,'rgba(255,0,85,0.1)'); g.addColorStop(1,'transparent');
            ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx, cy, 100+p, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='#ff0055'; ctx.beginPath(); ctx.arc(cx, cy, 35, 0, Math.PI*2); ctx.fill();
            ctx.save(); ctx.translate(cx, cy); ctx.rotate(Date.now()*0.0005);
            ctx.strokeStyle='rgba(255,100,150,0.4)'; ctx.lineWidth=2; ctx.beginPath(); ctx.ellipse(0,0,120,30,Math.PI/4,0,Math.PI*2); ctx.stroke();
            ctx.rotate(Math.PI/2); ctx.beginPath(); ctx.ellipse(0,0,100,40,-Math.PI/6,0,Math.PI*2); ctx.stroke(); ctx.restore();

            if(camera.zoom < 1.5) {
                ctx.textAlign='center'; ctx.textBaseline='middle';
                // [FIX] Title inside core
                ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=4; 
                ctx.fillStyle='#fff'; ctx.font='900 24px "Noto Sans TC"'; ctx.fillText("ÂøÉÁêÜÂÆáÂÆô", cx, cy-10); ctx.shadowBlur=0;
                ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='700 10px Orbitron'; ctx.fillText("M I N D V E R S E", cx, cy+15);
                ctx.textBaseline='alphabetic'; 
            }
        }

        function drawPlanetIcon(n, x, y, hover) {
            const scale=hover?1.2:1.0; ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
            if(hover){ctx.shadowColor=n.glow; ctx.shadowBlur=30;}
            ctx.fillStyle='rgba(10,10,20,0.8)'; ctx.beginPath(); ctx.arc(0,0,50,0,Math.PI*2); ctx.fill();
            ctx.shadowBlur=0; ctx.lineWidth=3; ctx.strokeStyle=n.color;

            if(n.type==='pentagon'){ ctx.beginPath(); for(let i=0;i<5;i++){const a=(i/5)*Math.PI*2-Math.PI/2;ctx.lineTo(Math.cos(a)*35,Math.sin(a)*35);}ctx.closePath();ctx.stroke(); ctx.lineWidth=1;ctx.beginPath();for(let i=0;i<5;i++){const a=(i/5)*Math.PI*2-Math.PI/2;ctx.lineTo(Math.cos(a)*20,Math.sin(a)*20);}ctx.closePath();ctx.stroke(); }
            else if(n.type==='hexagon'){ ctx.beginPath(); for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2;ctx.lineTo(Math.cos(a)*35,Math.sin(a)*35);}ctx.closePath();ctx.stroke(); ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,-35);ctx.lineTo(0,35);ctx.stroke(); }
            else if(n.type==='nonagon'){ ctx.beginPath(); for(let i=0;i<9;i++){const a=(i/9)*Math.PI*2-Math.PI/2;ctx.lineTo(Math.cos(a)*38,Math.sin(a)*38);}ctx.closePath();ctx.stroke(); ctx.lineWidth=1;ctx.beginPath();for(let i=0;i<3;i++){const a=(i/3)*Math.PI*2-Math.PI/2;ctx.lineTo(Math.cos(a)*38,Math.sin(a)*38);}ctx.closePath();ctx.stroke(); }
            else if(n.type==='radar'){ ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,35,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(0,0,22,0,Math.PI*2);ctx.stroke(); ctx.fillStyle=n.color;ctx.beginPath();ctx.ellipse(0,5,8,6,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(-10,-5,4,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(0,-10,4,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(10,-5,4,0,Math.PI*2);ctx.fill(); }
            else if(n.type==='rainbow'){ const gr=ctx.createLinearGradient(-35,-35,35,35);gr.addColorStop(0,'#f00');gr.addColorStop(0.2,'#ff0');gr.addColorStop(0.4,'#0f0');gr.addColorStop(0.6,'#0ff');gr.addColorStop(0.8,'#00f');gr.addColorStop(1,'#f0f');ctx.fillStyle=gr;ctx.beginPath();ctx.arc(0,0,35,0,Math.PI*2);ctx.fill(); }
            else if(n.type==='core'){ ctx.fillStyle='#ff3333';ctx.beginPath();ctx.arc(0,0,35,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ff6600';ctx.beginPath();ctx.arc(0,0,18,0,Math.PI*2);ctx.fill(); }
            
            ctx.strokeStyle=n.color; ctx.lineWidth=1; ctx.globalAlpha=0.5; ctx.beginPath(); ctx.arc(0,0,50,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
            ctx.restore();

            // Label always visible
            ctx.fillStyle = hover ? '#fff' : 'rgba(255,255,255,0.7)'; 
            ctx.font = (hover ? 'bold ' : '') + '16px "Noto Sans TC"'; 
            ctx.textAlign='center'; ctx.shadowColor='#000'; ctx.shadowBlur=4; 
            ctx.fillText(n.label, x, y+65*scale); ctx.shadowBlur=0;
        }

        // --- Transitions ---
        function enterGame(id, targetX, targetY) {
            activeGameId = id;
            currentScene = 'TRANSITION';
            camera.targetZoom = 5;
            camera.targetX = targetX - width/2;
            camera.targetY = targetY - height/2;

            setTimeout(() => {
                // RESET GAMES
                if(id==='BIG5') startBig5();
                if(id==='MBTI') startMBTI();
                if(id==='ENNEAGRAM') startEnneagram();
                if(id==='RIASEC') startRIASEC();
                if(id==='COLOR') startColorTest();
                if(id==='ANIMAL') startAnimalTest();
                
                currentScene = id; 
                camera.zoom = 1; camera.x = 0; camera.y = 0; 
            }, 1500);
        }

        function returnLobby() {
            currentScene = 'LOBBY';
            camera.zoom = 5; camera.targetZoom = 1; camera.x = 0; camera.y = 0; camera.targetX = 0; camera.targetY = 0;
        }

        // --- Games (Big 5) ---
        function startBig5() { gameSt.big5 = { idx:0, ans:3, scores:{O:0,C:0,E:0,A:0,N:0}, done:false }; }
        function drawBig5() {
            const st = gameSt.big5; const cx = width/2, cy = height/2;
            ctx.fillStyle = 'rgba(10,15,30,0.95)'; ctx.fillRect(0,0,width,height);
            if(!st.done) {
                const q = big5Data.qs[st.idx]; drawProgress(st.idx+1, big5Data.qs.length);
                drawTitle("‰∫îÂ§ßÊÄßÊ†ºÂàÜÊûê", cx, 80, styles.nodes.BIG5.color);
                ctx.fillStyle='#fff'; ctx.font='28px "Noto Sans TC"'; ctx.textAlign='center'; 
                // ‚úÖ [Fixed] Dynamic Wrap
                wrapText(q.t, cx, cy-50, Math.min(600, width-60), 40);
                
                // Slider (Hitbox enlarged)
                const sw = 300; const sy = cy+80; ctx.fillStyle = '#444'; ctx.fillRect(cx-sw/2, sy, sw, 6);
                const hx = cx - sw/2 + (sw * (st.ans-1)/4);
                hitZones.push({t:'rect', x:cx-sw/2-30, y:sy-40, w:sw+60, h:80, action: mx => st.ans = Math.max(1, Math.min(5, Math.round(((mx-(cx-sw/2))/sw)*4)+1)) });
                ctx.beginPath(); ctx.arc(hx, sy+3, 12, 0, Math.PI*2); ctx.fillStyle='#00f3ff'; ctx.fill();
                ctx.fillStyle='#888'; ctx.font='16px "Noto Sans TC"'; ctx.fillText("‰∏çÂêåÊÑè", cx-sw/2, sy+40); ctx.fillText("ÂêåÊÑè", cx+sw/2, sy+40);
                drawBtn(cx, cy+180, "‰∏ã‰∏ÄÈ°å", styles.nodes.BIG5.color, () => {
                    const sc = st.ans - 3; st.scores[q.k] += q.rev ? -sc : sc;
                    if(st.idx < big5Data.qs.length-1) { st.idx++; st.ans=3; } else st.done = true;
                });
            } else {
                let maxK='O', maxV=-99; for(let k in st.scores) if(st.scores[k]>maxV) { maxV=st.scores[k]; maxK=k; }
                const res = big5Data.results[maxK];
                drawTitle("ÂàÜÊûêÂÆåÊàê", cx, 80, styles.nodes.BIG5.color);
                ctx.font='bold 40px "Noto Sans TC"'; ctx.fillStyle='#fff'; ctx.fillText(res.t, cx, cy-120);
                drawRadar(cx, cy, 100, st.scores);
                // ‚úÖ [Fixed] Dynamic Wrap
                ctx.font='20px "Noto Sans TC"'; ctx.fillStyle='#ccc'; 
                wrapText(res.d, cx, cy+140, Math.min(500, width-60), 30);
                drawBtn(cx, height-100, "ËøîÂõûÂøÉÁêÜÂÆáÂÆô", 'rgba(255,255,255,0.2)', returnLobby);
            }
        }

        // --- Games (MBTI) ---
        function startMBTI() { gameSt.mbti = { idx:0, scores:{ei:0,sn:0,tf:0,jp:0}, done:false }; }
        function drawMBTI() {
            const st = gameSt.mbti; const cx = width/2, cy = height/2; ctx.fillStyle = '#1a0505'; ctx.fillRect(0,0,width,height);
            if(!st.done) {
                const q = mbtiData.qs[st.idx]; drawProgress(st.idx+1, mbtiData.qs.length);
                drawTitle("RPG ËÅ∑Ê•≠Ê∏¨È©ó", cx, 80, styles.nodes.MBTI.color);
                ctx.fillStyle='#fff'; ctx.font='28px "Noto Sans TC"'; ctx.textAlign='center'; 
                // ‚úÖ [Fixed] Dynamic Wrap
                wrapText(q.q, cx, cy-80, Math.min(600, width-60), 40);
                
                // [FIX] RWD Cards (Stack on Mobile)
                if (isMobile) {
                    drawCard(cx, cy+20, width-60, 80, "A", q.a, '#ff3333', ()=>{ st.scores[q.d]-=q.v; nextMBTI(); });
                    drawCard(cx, cy+120, width-60, 80, "B", q.b, '#ff3333', ()=>{ st.scores[q.d]+=q.v; nextMBTI(); });
                } else {
                    drawCard(cx-160, cy+50, 260, 160, "A", q.a, '#ff3333', ()=>{ st.scores[q.d]-=q.v; nextMBTI(); });
                    drawCard(cx+160, cy+50, 260, 160, "B", q.b, '#ff3333', ()=>{ st.scores[q.d]+=q.v; nextMBTI(); });
                }
            } else {
                const type = (st.scores.ei<0?'E':'I')+(st.scores.sn<0?'S':'N')+(st.scores.tf<0?'T':'F')+(st.scores.jp<0?'J':'P');
                const res = mbtiData.results[type] || mbtiData.results['ISTJ'];
                ctx.textAlign='center'; ctx.font='100px serif'; ctx.fillText(res.e, cx, cy-100);
                ctx.fillStyle='#ffcc00'; ctx.font='bold 40px "Noto Sans TC"'; ctx.fillText(res.t, cx, cy-20);
                ctx.fillStyle='#fff'; ctx.font='24px Orbitron'; ctx.fillText(type, cx, cy+30);
                // ‚úÖ [Fixed] Dynamic Wrap
                ctx.font='18px "Noto Sans TC"'; ctx.fillStyle='#ccc'; 
                wrapText(res.d, cx, cy+80, Math.min(500, width-60), 30);
                drawBtn(cx, height-100, "ËøîÂõûÂøÉÁêÜÂÆáÂÆô", 'rgba(255,255,255,0.2)', returnLobby);
            }
        }
        function nextMBTI() { if(gameSt.mbti.idx < mbtiData.qs.length-1) gameSt.mbti.idx++; else gameSt.mbti.done=true; }

        // --- Games (Enneagram) ---
        function startEnneagram() { gameSt.enn = { idx:0, scores:new Array(10).fill(0), done:false }; }
        function drawEnneagram() {
            const st = gameSt.enn; const cx=width/2, cy=height/2;
            const g = ctx.createLinearGradient(0,0,0,height); g.addColorStop(0,'#1a1005'); g.addColorStop(1,'#000'); ctx.fillStyle=g; ctx.fillRect(0,0,width,height);
            if(!st.done) {
                const q = ennData.qs[st.idx]; drawProgress(st.idx+1, ennData.qs.length);
                drawTitle("‰πùÂûã‰∫∫Ê†º", cx, 80, styles.nodes.ENNEAGRAM.color);
                ctx.fillStyle='#fff'; ctx.font='28px "Noto Sans TC"'; ctx.textAlign='center'; 
                // ‚úÖ [Fixed] Dynamic Wrap
                wrapText(q.q, cx, cy-80, Math.min(600, width-60), 40);
                
                // [FIX] RWD Buttons
                if (isMobile) {
                    drawBtn(cx, cy+20, q.a, '#cd7f32', ()=>{ q.ta.forEach(x=>st.scores[x]++); nextEnn(); }, width-60);
                    drawBtn(cx, cy+100, q.b, '#555', ()=>{ q.tb.forEach(x=>st.scores[x]++); nextEnn(); }, width-60);
                } else {
                    drawBtn(cx, cy+20, q.a, '#cd7f32', ()=>{ q.ta.forEach(x=>st.scores[x]++); nextEnn(); }, 300);
                    drawBtn(cx, cy+100, q.b, '#555', ()=>{ q.tb.forEach(x=>st.scores[x]++); nextEnn(); }, 300);
                }
            } else {
                let max = -1, type = 1; for(let i=1;i<=9;i++) if(st.scores[i]>max) { max=st.scores[i]; type=i; }
                const res = ennData.results[type];
                ctx.textAlign='center'; ctx.fillStyle='#ffd700'; ctx.font='bold 40px "Noto Sans TC"'; ctx.fillText(res.t, cx, cy-50);
                // ‚úÖ [Fixed] Dynamic Wrap
                ctx.fillStyle='#fff'; ctx.font='20px "Noto Sans TC"'; 
                wrapText(res.d, cx, cy+20, Math.min(500, width-60), 30);
                drawBtn(cx, height-100, "ËøîÂõûÂøÉÁêÜÂÆáÂÆô", 'rgba(255,255,255,0.2)', returnLobby);
            }
        }
        function nextEnn() { if(gameSt.enn.idx < ennData.qs.length-1) gameSt.enn.idx++; else gameSt.enn.done=true; }

        // --- Games (RIASEC) ---
        function startRIASEC() { gameSt.riasec = { idx:0, scores:{R:0,I:0,A:0,S:0,E:0,C:0}, done:false }; }
        function drawRIASEC() {
            const st = gameSt.riasec; const cx=width/2, cy=height/2; ctx.fillStyle='#001a1a'; ctx.fillRect(0,0,width,height);
            if(!st.done) {
                const q = riasecData.qs[st.idx]; drawProgress(st.idx+1, riasecData.qs.length);
                drawTitle("Ëç∑Ëò≠‰ª£Á¢º", cx, 80, '#00ced1');
                ctx.fillStyle='#fff'; ctx.font='28px "Noto Sans TC"'; ctx.textAlign='center'; ctx.fillText(`‰Ω†ÂñúÊ≠° "${q.q}" ÂóéÔºü`, cx, cy-50);
                drawBtn(cx-100, cy+80, "ÂñúÊ≠°", '#00ffcc', ()=>{ st.scores[q.t]+=1; nextRIASEC(); }, 140);
                drawBtn(cx+100, cy+80, "‰∏çÂñúÊ≠°", '#555', ()=>{ nextRIASEC(); }, 140);
            } else {
                const sorted = Object.entries(st.scores).sort((a,b)=>b[1]-a[1]); const code = sorted.slice(0,3).map(x=>x[0]).join('-');
                drawHexagon(cx, cy-100, 100, st.scores);
                ctx.fillStyle='#00ffcc'; ctx.font='bold 40px Orbitron'; ctx.textAlign='center'; ctx.fillText(code, cx, cy+60);
                let ty = cy+100;
                sorted.slice(0,3).forEach(item => { 
                    ctx.fillStyle='#fff'; ctx.font='16px "Noto Sans TC"'; 
                    // ‚úÖ [Fixed] Use fillText with maxWidth constraint
                    ctx.fillText(riasecData.desc[item[0]], cx, ty, width - 60); 
                    ty+=25; 
                });
                drawBtn(cx, height-100, "ËøîÂõûÂøÉÁêÜÂÆáÂÆô", 'rgba(255,255,255,0.2)', returnLobby);
            }
        }
        function nextRIASEC() { if(gameSt.riasec.idx < riasecData.qs.length-1) gameSt.riasec.idx++; else gameSt.riasec.done=true; }
        
        function drawHexagon(cx, cy, r, scores) {
            ctx.strokeStyle='#00ffcc'; ctx.lineWidth=1; ctx.beginPath();
            for(let i=0;i<6;i++) { const a=i/6*Math.PI*2-Math.PI/2; ctx[i===0?'moveTo':'lineTo'](cx+Math.cos(a)*r, cy+Math.sin(a)*r); } ctx.closePath(); ctx.stroke();
            const keys=['R','I','A','S','E','C']; ctx.fillStyle='rgba(0,255,204,0.3)'; ctx.beginPath();
            for(let i=0;i<6;i++) { const v=Math.min(scores[keys[i]]||0, 3)/3*r; const a=i/6*Math.PI*2-Math.PI/2; ctx[i===0?'moveTo':'lineTo'](cx+Math.cos(a)*v, cy+Math.sin(a)*v); } ctx.closePath(); ctx.fill();
            ctx.fillStyle='#fff'; ctx.font='14px Orbitron'; for(let i=0;i<6;i++) { const a=i/6*Math.PI*2-Math.PI/2; ctx.fillText(keys[i], cx+Math.cos(a)*(r+20), cy+Math.sin(a)*(r+20)); }
        }

        // --- Games (Color) ---
        function startColorTest() { gameSt.color = { phase:0, sel:[], auraT:0, done:false }; }
        function drawColorTest() {
            const st = gameSt.color; const cx=width/2, cy=height/2; ctx.fillStyle='#111'; ctx.fillRect(0,0,width,height);
            if(st.phase < 3) {
                drawTitle("Ëâ≤ÂΩ©ÂøÉÁêÜ", cx, 80, '#ff00ff');
                let txt = "Áõ¥Ë¶∫ÈÅ∏ÊìáÊúÄÂê∏Âºï‰Ω†ÁöÑÈ°èËâ≤";
                if(st.phase===1) txt = "ÈÅ∏ÊìáÁ¨¨‰∫åÂê∏Âºï‰Ω†ÁöÑÈ°èËâ≤";
                if(st.phase===2) txt = "ÈÅ∏ÊìáÊúÄ‰∏çÂñúÊ≠°ÁöÑÈ°èËâ≤";
                ctx.fillStyle='#fff'; ctx.font='24px "Noto Sans TC"'; ctx.textAlign='center'; 
                // ‚úÖ [Fixed] Dynamic Wrap for question
                ctx.fillText(txt, cx, cy-150, width - 60);
                const palette = [{id:1,c:'#A9A9A9'},{id:2,c:'#0000FF'},{id:3,c:'#008000'},{id:4,c:'#FF0000'},{id:5,c:'#FFFF00'},{id:6,c:'#800080'},{id:7,c:'#8B4513'},{id:8,c:'#333333'}];
                palette.forEach((c,i)=>{
                    if(st.sel.find(s=>s.id===c.id)) return;
                    const a=(i/8)*Math.PI*2; const x=cx+Math.cos(a)*100; const y=cy+Math.sin(a)*100;
                    ctx.beginPath(); ctx.arc(x,y,35,0,Math.PI*2); ctx.fillStyle=c.c; ctx.fill(); ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
                    hitZones.push({t:'circle', x:x, y:y, r:40, action:()=>{ st.sel.push(c); st.phase++; }});
                });
            } else {
                st.auraT += 0.02;
                const c1=st.sel[0], c2=st.sel[1], c3=st.sel[2];
                ctx.globalCompositeOperation='screen';
                const d=Math.sin(st.auraT)*10; 
                let g=ctx.createRadialGradient(cx,cy-50,20,cx,cy-50,120+d); g.addColorStop(0,c1.c); g.addColorStop(1,'transparent');
                ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy-50,120+d,0,Math.PI*2); ctx.fill();
                ctx.globalCompositeOperation='source-over';
                ctx.textAlign='center'; ctx.fillStyle='#fff'; ctx.font='22px "Noto Sans TC"';
                // ‚úÖ [Fixed] Use fillText with maxWidth constraint
                ctx.fillText(`È°ØÊÄßÊ∏¥Êúõ: ${colorMeanings[c1.id]}`, cx, cy+100, width - 60);
                ctx.fillStyle='#ccc'; 
                ctx.fillText(`Ê¨°Ë¶ÅÂãïÂäõ: ${colorMeanings[c2.id]}`, cx, cy+140, width - 60);
                ctx.fillStyle='#888'; 
                ctx.fillText(`Èö±ÊÄßÊäóÊãí: ${colorMeanings[c3.id]}`, cx, cy+180, width - 60);
                drawBtn(cx, height-100, "ËøîÂõûÂøÉÁêÜÂÆáÂÆô", 'rgba(255,255,255,0.2)', returnLobby);
            }
        }
        function drawBlob(x,y,r,c,t) { const d=Math.sin(t)*20; const g=ctx.createRadialGradient(x,y,r*0.1,x,y,r+d); g.addColorStop(0,c); g.addColorStop(1,'transparent'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r+d,0,Math.PI*2); ctx.fill(); }

        // --- Games (Animal) ---
        function startAnimalTest() { gameSt.animal = { idx:0, pos:{x:0, y:0}, parts:[], done:false }; }
        function drawAnimalTest() {
            const st = gameSt.animal; const cx=width/2, cy=height/2; ctx.fillStyle='#051105'; ctx.fillRect(0,0,width,height);
            if(!st.done) {
                const q = animalData.qs[st.idx]; drawProgress(st.idx+1, animalData.qs.length);
                drawTitle("ÂãïÁâ©ÂúñÈ®∞", cx, 80, '#32cd32');
                ctx.fillStyle='#fff'; ctx.font='28px "Noto Sans TC"'; ctx.textAlign='center'; 
                // ‚úÖ [Fixed] Dynamic Wrap
                wrapText(q.q, cx, cy-80, Math.min(600, width-60), 40);
                
                // [FIX] RWD Cards (Stack on Mobile)
                if (isMobile) {
                    drawCard(cx, cy+20, width-60, 80, "A", q.a, '#32cd32', ()=>{ st.pos[q.ax]+=q.v; nextAnimal(); });
                    drawCard(cx, cy+120, width-60, 80, "B", q.b, '#32cd32', ()=>{ st.pos[q.ax]-=q.v; nextAnimal(); });
                } else {
                    drawCard(cx-160, cy+50, 260, 160, "A", q.a, '#32cd32', ()=>{ st.pos[q.ax]+=q.v; nextAnimal(); });
                    drawCard(cx+160, cy+50, 260, 160, "B", q.b, '#32cd32', ()=>{ st.pos[q.ax]-=q.v; nextAnimal(); });
                }
            } else {
                const x=st.pos.x, y=st.pos.y;
                let res=animalData.results['D']; if(x>0 && y<=0) res=animalData.results['I']; else if(x>0 && y>0) res=animalData.results['S']; else if(x<=0 && y>0) res=animalData.results['C'];
                ctx.textAlign='center'; ctx.font='100px serif'; ctx.fillText(res.e, cx, cy-80);
                ctx.fillStyle='#adff2f'; ctx.font='bold 40px "Noto Sans TC"'; ctx.fillText(res.t, cx, cy+20);
                // ‚úÖ [Fixed] Dynamic Wrap
                ctx.fillStyle='#fff'; ctx.font='20px "Noto Sans TC"'; 
                wrapText(res.d, cx, cy+70, Math.min(500, width-60), 30);
                drawBtn(cx, height-100, "ËøîÂõûÂøÉÁêÜÂÆáÂÆô", 'rgba(255,255,255,0.2)', returnLobby);
            }
        }
        function nextAnimal() { if(gameSt.animal.idx<animalData.qs.length-1) gameSt.animal.idx++; else gameSt.animal.done=true; }

        // --- Helpers ---
        function drawTitle(txt, x, y, color) { ctx.textAlign='center'; ctx.fillStyle=color; ctx.font='bold 32px "Noto Sans TC"'; ctx.shadowColor=color; ctx.shadowBlur=20; ctx.fillText(txt, x, y); ctx.shadowBlur=0; }
        function drawBtn(x, y, txt, color, act, w=200) {
            const h=50; const hover = Math.abs(mouse.x - x) < w/2 && Math.abs(mouse.y - (y+h/2)) < h/2;
            // [Fix] Background always visible
            ctx.fillStyle=hover?'#fff':color; ctx.beginPath(); ctx.roundRect(x-w/2, y, w, h, 25); ctx.fill();
            ctx.fillStyle=hover?'#000':'#fff'; ctx.textAlign='center'; ctx.font='bold 18px "Noto Sans TC"'; ctx.fillText(txt, x, y+32);
            hitZones.push({t:'rect', x:x-w/2, y:y, w:w, h:h, action:act});
        }
        function drawCard(x, y, w, h, t, txt, c, act) { 
            // x, y is center.
            const hover=Math.abs(mouse.x - x) < w/2 && Math.abs(mouse.y - (y+h/2)) < h/2;
            ctx.strokeStyle=hover?c:'#555'; ctx.lineWidth=2; ctx.fillStyle=hover?'rgba(255,255,255,0.1)':'rgba(30,30,30,0.8)';
            ctx.beginPath(); ctx.roundRect(x-w/2, y, w, h, 15); ctx.fill(); ctx.stroke();
            // Centering text
            ctx.fillStyle=c; ctx.font='30px Orbitron'; ctx.textAlign='center'; ctx.fillText(t, x, y+50);
            ctx.fillStyle='#fff'; ctx.font='20px "Noto Sans TC"'; ctx.fillText(txt, x, y+90);
            hitZones.push({t:'rect', x:x-w/2, y:y, w:w, h:h, action:act});
        }
        function drawProgress(curr, total) { ctx.textAlign='right'; ctx.fillStyle='#00f3ff'; ctx.font='16px Orbitron'; ctx.fillText(`${curr}/${total}`, width-20, 40); }
        function drawRadar(cx, cy, r, scores) {
            const keys=['O','C','E','A','N']; ctx.strokeStyle='#555'; ctx.beginPath();
            for(let i=0;i<5;i++){ const a=i/5*Math.PI*2-Math.PI/2; ctx.lineTo(cx+Math.cos(a)*r, cy+Math.sin(a)*r); } ctx.closePath(); ctx.stroke();
            ctx.fillStyle='rgba(0,243,255,0.3)'; ctx.beginPath();
            keys.forEach((k,i)=>{ const v=Math.max(0.2, (scores[k]+6)/12)*r; ctx.lineTo(cx+Math.cos(i/5*Math.PI*2-Math.PI/2)*v, cy+Math.sin(i/5*Math.PI*2-Math.PI/2)*v); }); ctx.closePath(); ctx.fill();
        }
        // [FIXED] Robust wrapText
        function wrapText(txt, x, y, maxW, lh) {
            if(!txt) return; const chars = txt.split(''); let line = ''; let cy = y;
            for(let n=0; n<chars.length; n++) {
                const test = line + chars[n];
                if(ctx.measureText(test).width > maxW && n>0) { ctx.fillText(line, x, cy); line = chars[n]; cy += lh; } 
                else { line = test; }
            }
            ctx.fillText(line, x, cy);
        }

        function loop() {
            camera.zoom += (camera.targetZoom - camera.zoom)*0.05;
            camera.x += (camera.targetX - camera.x)*0.05;
            camera.y += (camera.targetY - camera.y)*0.05;
            ctx.clearRect(0,0,width,height); hitZones=[];
            drawStars();
            if(currentScene==='LOBBY'||currentScene==='TRANSITION') {
                ctx.save(); ctx.translate(width/2, height/2); ctx.scale(camera.zoom, camera.zoom); ctx.translate(-width/2-camera.x, -height/2-camera.y);
                drawLobby(); ctx.restore();
                // Draw Footer in Screen Space
                if(camera.zoom < 1.5) {
                    ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.font='12px Orbitron'; ctx.textAlign='center';
                    ctx.fillText("Copyright ¬© JOBUS ASIA 2025", width/2, height-20);
                }
            } else {
                if(currentScene==='BIG5') drawBig5(); else if(currentScene==='MBTI') drawMBTI(); else if(currentScene==='ENNEAGRAM') drawEnneagram();
                else if(currentScene==='RIASEC') drawRIASEC(); else if(currentScene==='COLOR') drawColorTest(); else if(currentScene==='ANIMAL') drawAnimalTest();
            }
            requestAnimationFrame(loop);
        }
        init(); loop();
    </script>
</body>
</html>