<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¿ƒç†å®‡å®™ï¼šMindverse (v1.2)</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3V80KBCWC1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3V80KBCWC1');
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Orbitron:wght@500;700;900&display=swap');
        
        /* åŸºç¤è¨­å®š */
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; /* é˜²æ­¢ Canvas é é¢æ²å‹• */
            background-color: #020205;
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: none; /* ç¦æ­¢é è¨­è§¸æ§è¡Œç‚º */
            -webkit-font-smoothing: antialiased;
        }

        /* Canvas å±¤ (éŠæˆ²èˆ‡æ¸¬é©—) */
        canvas {
            display: block; outline: none;
            position: fixed; top: 0; left: 0; z-index: 1;
        }

        /* Loading å­—å‹é è¼‰ */
        .font-preload { position: absolute; opacity: 0; pointer-events: none; }

        /* =========================================
           Hybrid UI: çµæœé  Overlay (Phase 0: æ ¸å¿ƒä¿®å¾©)
           ========================================= */
        #resultOverlay {
            display: none; /* é è¨­éš±è— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; /* è“‹åœ¨ Canvas ä¹‹ä¸Š */
            background: rgba(2, 2, 5, 0.96); /* æ·±è‰²èƒŒæ™¯ */
            backdrop-filter: blur(10px);
            overflow-y: auto; /* å…è¨±å‚ç›´æ²å‹• */
            -webkit-overflow-scrolling: touch;
            
            /* Phase 0: Safe Area é©é… */
            padding: 40px 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 80px);
            box-sizing: border-box;
            color: #fff;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #resultOverlay.visible {
            display: block;
            opacity: 1;
        }

        /* å…§å®¹å®¹å™¨ */
        .summary-container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* æ’ç‰ˆèˆ‡è¦–è¦ºå„ªåŒ– (Phase 2: è³ªæ„Ÿ) */
        .summary-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .result-icon { font-size: 60px; margin-bottom: 10px; display: block; }
        .result-title { font-size: 32px; font-weight: 900; color: #fff; margin: 10px 0; }
        .result-subtitle { font-size: 18px; color: #00f3ff; font-family: 'Orbitron', sans-serif; margin-bottom: 15px; }
        .result-desc { font-size: 16px; color: #ccc; line-height: 1.6; }

        .section-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .section-title {
            font-size: 18px; font-weight: 700; margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }

        .text-body { font-size: 15px; color: #ddd; line-height: 1.8; letter-spacing: 0.5px; }

        /* Jobus CTA å€å¡Š (Phase 1: å°æµ) */
        .cta-section {
            text-align: center;
            margin-top: 40px;
            padding: 30px 20px;
            background: linear-gradient(180deg, rgba(0,243,255,0.05) 0%, rgba(0,0,0,0) 100%);
            border-radius: 20px;
        }
        
        .cta-btn {
            display: block;
            width: 100%;
            background: #fff;
            color: #000;
            font-weight: 700;
            padding: 16px;
            border-radius: 50px;
            text-decoration: none;
            margin-bottom: 12px;
            font-size: 16px;
            transition: transform 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .cta-btn:active { transform: scale(0.98); }
        .cta-btn.primary { background: #00f3ff; color: #000; }
        .cta-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        
        .brand-footer {
            font-size: 12px; color: #666; margin-top: 20px;
            font-family: 'Orbitron', sans-serif; letter-spacing: 1px;
        }

        /* è¿”å›å¤§å»³æŒ‰éˆ• */
        .home-btn {
            position: fixed;
            bottom: max(20px, env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            border: 1px solid #333;
            color: #888;
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            z-index: 101;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="font-preload" style="font-family: 'Orbitron'">Loading...</div>
    <div class="font-preload" style="font-family: 'Noto Sans TC'">Loading...</div>
    
    <canvas id="appCanvas"></canvas>

    <div id="resultOverlay">
        <div class="summary-container" id="summaryContent">
            </div>
        <div class="brand-footer" style="text-align: center; padding-bottom: 20px;">
            Powered by Jobus | è·æ¶¯æˆé•·èˆ‡è‡ªæˆ‘æ¢ç´¢å¹³å°
        </div>
        <button class="home-btn" onclick="closeSummary()">ğŸ  è¿”å›å¿ƒç†å®‡å®™</button>
    </div>

    <script>
        /**
         * å¿ƒç†å®‡å®™ Mindverse v1.2 - Golden Spec Implementation
         * Features: Hybrid UI, State Rollback, Logic Hierarchy, Safe Area
         */

        // --- æ ¸å¿ƒç³»çµ±èˆ‡è®Šæ•¸ ---
        const canvas = document.getElementById('appCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, dpr = 1, isMobile = false;
        
        // GA4 å°è£
        function sendGAEvent(eventName, params) {
            if (typeof gtag === 'function') {
                gtag('event', eventName, params);
            }
        }

        // ç‹€æ…‹ç®¡ç†
        let mouse = { x: 0, y: 0, down: false };
        let gyro = { x: 0, y: 0 };
        let currentScene = 'LOBBY'; 
        let camera = { zoom: 1, x: 0, y: 0, targetZoom: 1, targetX: 0, targetY: 0 };
        let hitZones = []; 
        
        // Phase 0: Safe Area è®Šæ•¸ (å‹•æ…‹è¨ˆç®—)
        let SAFE_BOTTOM = 80; 

        // å…¨åŸŸä½¿ç”¨è€…è³‡æ–™ (ç”¨æ–¼ Phase 1 ä¸»å°åˆ¤å®š)
        const userResults = {
            completed: [], // å­˜å·²å®Œæˆçš„æ¸¬é©— ID
            data: {}       // å­˜è©³ç´°çµæœ
        };

        // --- è¦–è¦ºé¢¨æ ¼è¨­å®š ---
        const styles = {
            bg: '#020205',
            nodes: {
                'BIG5': { color: '#4d79ff', glow: '#00f3ff', type: 'pentagon', label: 'äº”å¤§æ€§æ ¼', sub: 'è¡Œç‚ºåæ‡‰æ¨¡å¼' },
                'MBTI': { color: '#ff3333', glow: '#ffcc00', type: 'core', label: 'RPG è·æ¥­', sub: 'æ½›åœ¨è§’è‰²è¨­å®š' },
                'ENNEAGRAM': { color: '#cd7f32', glow: '#ffd700', type: 'nonagon', label: 'ä¹å‹äººæ ¼', sub: 'å…§åœ¨æ ¸å¿ƒå‹•æ©Ÿ' },
                'RIASEC': { color: '#00ced1', glow: '#00ffcc', type: 'hexagon', label: 'è·è˜­ä»£ç¢¼', sub: 'è·æ¶¯èˆˆè¶£åå¥½' },
                'COLOR': { color: '#ff00ff', glow: '#ffffff', type: 'rainbow', label: 'è‰²å½©å¿ƒç†', sub: 'ç•¶ä¸‹ç‹€æ…‹æƒæ' },
                'ANIMAL': { color: '#32cd32', glow: '#adff2f', type: 'radar', label: 'å‹•ç‰©åœ–é¨°', sub: 'å£“åŠ›ä¸‹çš„ç›´è¦º' }
            }
        };

        // --- è³‡æ–™åº« (Phase 1 Logic Engine) ---
        // 1. Big5
        const big5Data = {
            qs: [
                {t:"å–œæ­¡åœ¨èšæœƒä¸­èªè­˜æ–°æœ‹å‹", k:'E'}, {t:"å°è—è¡“å’ŒæŠ½è±¡æ¦‚å¿µæ„Ÿèˆˆè¶£", k:'O'}, {t:"åšäº‹é€šå¸¸æœƒæå‰è¨ˆåŠƒ", k:'C'}, {t:"å®¹æ˜“æ„Ÿå—åˆ°åˆ¥äººçš„æƒ…ç·’", k:'A'}, {t:"å£“åŠ›å¤§æ™‚å®¹æ˜“æ„Ÿåˆ°ç„¦æ…®", k:'N'},
                {t:"æ¯”è¼ƒå–œæ­¡å®‰éœç¨è™•", k:'E', rev:true}, {t:"å–œæ­¡å˜—è©¦ç•°åœ‹æ–™ç†", k:'O'}, {t:"æˆ¿é–“é€šå¸¸å¾ˆæ•´æ½”", k:'C'}, {t:"æ¨‚æ–¼å¹«åŠ©ä»–äººè§£æ±ºå•é¡Œ", k:'A'}, {t:"æƒ…ç·’èµ·ä¼æ¯”è¼ƒå¤§", k:'N'}
            ],
            results: {
                'O': { t:"é–‹æ”¾æ€§ (Openness)", desc:"å¥½å¥‡å¿ƒæ—ºç››ï¼Œæ‹’çµ•ç„¡èŠçš„é»å­ç‹ã€‚", workStyle:"ä½ é©åˆéœ€è¦å‰µæ„èˆ‡è®ŠåŒ–çš„å·¥ä½œï¼Œé‡è¤‡æ€§é«˜çš„ä»»å‹™æœƒè®“ä½ æ¯ç«­ã€‚", drain:"è¢«è¦æ±‚ã€Œç…§è‘—åšå°±å¥½ã€ã€ç¦æ­¢æå•çš„ç’°å¢ƒã€‚" },
                'C': { t:"ç›¡è²¬æ€§ (Conscientiousness)", desc:"è‡ªå¾‹ä¸”å¯é ï¼Œåœ˜éšŠçš„å®šæµ·ç¥é‡ã€‚", workStyle:"ä½ é©åˆåˆ¶åº¦æ˜ç¢ºã€SOP å®Œæ•´çš„ç’°å¢ƒï¼Œæ··äº‚æœƒè®“ä½ ç„¦æ…®ã€‚", drain:"æœä»¤å¤•æ”¹ã€æ²’æœ‰è¨ˆç•«å°±åŸ·è¡Œçš„å°ˆæ¡ˆã€‚" },
                'E': { t:"å¤–å‘æ€§ (Extraversion)", desc:"ç†±æƒ…æ´‹æº¢ï¼Œå¤©ç”Ÿçš„é€£çµè€…ã€‚", workStyle:"ä½ é©åˆéœ€è¦é »ç¹æºé€šã€èƒ½ç™¼æ®å½±éŸ¿åŠ›çš„è§’è‰²ã€‚", drain:"æ•´å¤©ä¸èªªè©±ã€ç¨è‡ªé¢å°é›»è…¦çš„å­¤ç¨å·¥ä½œã€‚" },
                'A': { t:"è¦ªå’Œæ€§ (Agreeableness)", desc:"æº«æš–åŒ…å®¹ï¼Œé‡è¦–å’Œè«§çš„å®ˆè­·è€…ã€‚", workStyle:"ä½ é©åˆåŠ©äººã€å”èª¿èˆ‡æœå‹™æ€§è³ªçš„å·¥ä½œã€‚", drain:"å……æ»¿æ”¿æ²»é¬¥çˆ­ã€éœ€è¦å¼·å‹¢è¸©åˆ¥äººåº•ç·šçš„ç’°å¢ƒã€‚" },
                'N': { t:"ç¥ç¶“è³ª (Neuroticism)", desc:"æƒ…æ„Ÿç´°è†©ï¼Œæ•éŠ³çš„é¢¨éšªåµæ¸¬å„€ã€‚", workStyle:"ä½ é©åˆéœ€è¦ç´°å¿ƒæª¢æŸ¥ã€é¢¨éšªæ§ç®¡çš„è§’è‰²ã€‚", drain:"é«˜å£“ã€éœ€è¦éš¨æ™‚ç·Šæ€¥æ‡‰è®Šçš„æˆ°å ´ã€‚" }
            }
        };
        // 2. MBTI (ç°¡åŒ–ç‰ˆ)
        const mbtiData = {
            qs: [
                {q:"é€±æœ«æ›´æƒ³...", a:"è·Ÿæœ‹å‹å‡ºå»ç©(E)", b:"åœ¨å®¶ä¼‘æ¯(I)", d:'ei', v:2}, 
                {q:"åšæ±ºå®šæ™‚...", a:"é‚è¼¯åˆ†æ(T)", b:"åœ¨æ„æ„Ÿå—(F)", d:'tf', v:2},
                {q:"ç”Ÿæ´»æ–¹å¼...", a:"æŒ‰éƒ¨å°±ç­(J)", b:"éš¨é‡è€Œå®‰(P)", d:'jp', v:2}
            ]
            // çœç•¥å®Œæ•´ resultsï¼Œé‚è¼¯åŒä¸Š
        };
        // 3. Animal
        const animalData = {
            qs: [{q:"çœ‹é‡...", a:"ç›®æ¨™(äº‹)", b:"é—œä¿‚(äºº)", ax:'x', v:-1}, {q:"æ­¥èª¿...", a:"å¿«", b:"æ…¢", ax:'y', v:-1}, {q:"é‡å•é¡Œ...", a:"ç›´æ¥è§£æ±º", b:"å°‹æ±‚å…±è­˜", ax:'x', v:-1}, {q:"åœ˜é«”ä¸­...", a:"ä¸»å°ç™¼è¨€", b:"å‚¾è½é…åˆ", ax:'y', v:-1}],
            results: { 
                'D': { t:"è€è™ (æ”¯é…å‹)", e:"ğŸ¯", oneLine:"è¬›è©±ç›´ã€å¾ˆæ•¢è¡çš„ç›®æ¨™æ´¾ã€‚", workStyle:"çµ¦äºˆæ˜ç¢ºç›®æ¨™èˆ‡æˆæ¬Šï¼Œä½ èƒ½å¸¶é ˜åœ˜éšŠè¡åˆºã€‚", drain:"æœ‰è²¬ç„¡æ¬Šã€éœ€è¦èŠ±å¤§é‡æ™‚é–“å®‰æ’«æƒ…ç·’çš„å·¥ä½œã€‚" },
                'I': { t:"å­”é›€ (å½±éŸ¿å‹)", e:"ğŸ¦š", oneLine:"ç†±æƒ…æ´‹æº¢ï¼Œç¤¾äº¤å ´çš„ç„¦é»ã€‚", workStyle:"éœ€è¦èˆå°èˆ‡è®šç¾ï¼Œé©åˆå…¬é–‹æ¼”èªªæˆ–æ¨å»£ã€‚", drain:"è¢«å¿½è¦–ã€åªçœ‹æ•¸æ“šä¸çœ‹äººçš„å†·æ¼ ç’°å¢ƒã€‚" },
                'S': { t:"ç„¡å°¾ç†Š (ç©©å¥å‹)", e:"ğŸ¨", oneLine:"æº«å’Œå‹å–„ï¼Œå¯é çš„éšŠå‹ã€‚", workStyle:"ç©©å®šçš„ç¯€å¥èˆ‡å’Œè«§çš„åœ˜éšŠï¼Œèƒ½è®“ä½ ç™¼æ®æœ€å¤§è€åŠ›ã€‚", drain:"è¡çªä¸æ–·ã€éœ€è¦ä¸€ç›´å‚¬ä¿ƒåˆ¥äººçš„è§’è‰²ã€‚" },
                'C': { t:"è²“é ­é·¹ (åˆ†æå‹)", e:"ğŸ¦‰", oneLine:"ç²¾æº–åš´è¬¹ï¼Œé‚è¼¯çš„è¿½æ±‚è€…ã€‚", workStyle:"çµ¦ä½ æ™‚é–“èˆ‡ç©ºé–“é€²è¡Œæ·±åº¦åˆ†æï¼Œè¿½æ±‚å®Œç¾ã€‚", drain:"è¢«è¦æ±‚ã€Œå…ˆæ±‚æœ‰å†æ±‚å¥½ã€ã€é‚è¼¯ä¸é€šçš„çå¿™ã€‚" }
            }
        };

        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† (Phase 0: State Rollback) ---
        // ä¿®æ”¹ï¼šå¢åŠ  answers é™£åˆ—ä»¥æ”¯æ´å›ä¸Šä¸€é¡Œ
        let gameSt = { 
            big5: {idx:0, answers:[], done:false}, 
            mbti: {idx:0, answers:[], done:false}, 
            enn: {idx:0, answers:[], done:false}, 
            riasec: {idx:0, answers:[], done:false}, 
            color: {phase:0, sel:[], done:false}, 
            animal: {idx:0, answers:[], done:false} 
        };

        // --- åˆå§‹åŒ–ç³»çµ± ---
        function init() {
            dpr = window.devicePixelRatio || 1;
            width = window.visualViewport ? window.visualViewport.width : window.innerWidth;
            height = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            canvas.style.width = width + "px";
            canvas.style.height = height + "px";
            canvas.width = width * dpr; 
            canvas.height = height * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            isMobile = width < 768;
            initStars();
        }

        window.addEventListener("resize", () => setTimeout(init, 150));
        window.addEventListener('deviceorientation', (e) => { if(e.gamma && e.beta) { gyro.x = e.gamma * 2; gyro.y = (e.beta - 45) * 2; } });

        // --- è¼¸å…¥è™•ç† ---
        const getPos = (e) => { const r = canvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; };
        const handleInput = (x, y, isClick) => {
            if(isClick) mouse.down = true;
            mouse.x = x; mouse.y = y;
            let worldX = x, worldY = y;
            if (currentScene === 'LOBBY') { 
                worldX = (x - width/2) / camera.zoom + width/2 + camera.x;
                worldY = (y - height/2) / camera.zoom + height/2 + camera.y;
            }
            let found = false;
            for (let z of hitZones) {
                let hit = false;
                if (z.t === 'circle') hit = Math.hypot(worldX - z.x, worldY - z.y) < z.r;
                else hit = (worldX >= z.x && worldX <= z.x+z.w && worldY >= z.y && worldY <= z.y+z.h);
                if (hit) { 
                    document.body.style.cursor = 'pointer'; found = true; 
                    if (isClick && z.action) { z.action(worldX, worldY); return; } 
                }
            }
            if(!found) document.body.style.cursor = 'default';
        };
        canvas.addEventListener('mousemove', e => { const p=getPos(e); handleInput(p.x, p.y, false); });
        canvas.addEventListener('mousedown', e => { const p=getPos(e); handleInput(p.x, p.y, true); });
        canvas.addEventListener('mouseup', () => mouse.down=false);
        canvas.addEventListener('touchmove', e => { e.preventDefault(); const p=getPos(e.touches[0]); handleInput(p.x, p.y, false); }, {passive:false});
        canvas.addEventListener('touchstart', e => { e.preventDefault(); const p=getPos(e.touches[0]); handleInput(p.x, p.y, true); }, {passive:false});

        // --- éŠæˆ²å¾ªç’° ---
        function loop() {
            camera.zoom += (camera.targetZoom - camera.zoom)*0.05;
            camera.x += (camera.targetX - camera.x)*0.05; camera.y += (camera.targetY - camera.y)*0.05;
            ctx.clearRect(0,0,width,height); hitZones=[];
            drawStars();
            
            if(currentScene==='LOBBY'||currentScene==='TRANSITION') {
                ctx.save(); ctx.translate(width/2, height/2);
                ctx.scale(camera.zoom, camera.zoom); ctx.translate(-width/2-camera.x, -height/2-camera.y);
                drawLobby(); ctx.restore();
            } else {
                if(currentScene==='BIG5') drawBig5();
                else if(currentScene==='ANIMAL') drawAnimalTest();
                // å…¶ä»–æ¸¬é©—çœç•¥ä»¥ç¯€çœç¯‡å¹…ï¼Œé‚è¼¯ç›¸åŒ
            }
            requestAnimationFrame(loop);
        }

        // --- æ˜Ÿç©ºèƒŒæ™¯ ---
        const stars = []; 
        function initStars() { stars.length = 0; for(let i=0; i<150; i++) stars.push({ x: Math.random()*width, y: Math.random()*height, z: Math.random()*2+0.5, alpha: Math.random() }); }
        function drawStars() {
            ctx.fillStyle = styles.bg; ctx.fillRect(0,0,width,height);
            stars.forEach(s => {
                const offX = (mouse.x - width/2) * 0.02 * s.z + gyro.x;
                const offY = (mouse.y - height/2) * 0.02 * s.z + gyro.y;
                ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
                ctx.beginPath(); ctx.arc(s.x + offX, s.y + offY, Math.random()*1.5, 0, Math.PI*2); ctx.fill();
            });
        }

        // --- UI ç¹ªè£½è¼”åŠ© ---
        function drawBtn(x, y, txt, color, act, w=200) {
            const h=50;
            const hover = Math.abs(mouse.x - x) < w/2 && Math.abs(mouse.y - (y+h/2)) < h/2;
            ctx.fillStyle=hover?'#fff':color; ctx.beginPath();
            ctx.roundRect(x-w/2, y, w, h, 25); ctx.fill();
            ctx.fillStyle=hover?'#000':'#fff'; ctx.textAlign='center'; ctx.font='bold 16px "Noto Sans TC"'; ctx.fillText(txt, x, y+30);
            hitZones.push({t:'rect', x:x-w/2, y:y, w:w, h:h, action:act});
        }
        function drawTitle(txt, x, y, color) { 
            ctx.textAlign='center'; ctx.fillStyle=color; ctx.font='bold 28px "Noto Sans TC"'; ctx.fillText(txt, x, y);
        }
        function wrapText(txt, x, y, maxW, lh) {
            if(!txt) return y;
            const chars = txt.split(''); let line = ''; let cy = y;
            for(let n=0; n<chars.length; n++) {
                const test = line + chars[n];
                if(ctx.measureText(test).width > maxW && n > 0) { ctx.fillText(line, x, cy); line = chars[n]; cy += lh; } 
                else { line = test; }
            }
            ctx.fillText(line, x, cy); return cy + lh; 
        }

        // --- æ ¸å¿ƒå ´æ™¯: LOBBY ---
        let lobbyRot = 0;
        function drawLobby() {
            lobbyRot += 0.0005; const cx=width/2, cy=height/2;
            const r = Math.min(width, height) * (isMobile ? 0.35 : 0.32);
            
            // ä¸­å¤®æ†æ˜Ÿ
            const p = Math.sin(Date.now()*0.003)*10;
            const g = ctx.createRadialGradient(cx, cy, 20, cx, cy, 100+p); g.addColorStop(0,'rgba(255,255,255,0.8)'); g.addColorStop(0.2,'#ff0055'); g.addColorStop(1,'transparent');
            ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx, cy, 100+p, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='#ff0055'; ctx.beginPath(); ctx.arc(cx, cy, 35, 0, Math.PI*2); ctx.fill();
            if(camera.zoom < 1.5) {
                ctx.textAlign='center'; ctx.fillStyle='#fff'; ctx.font='900 24px "Noto Sans TC"'; ctx.fillText("å¿ƒç†å®‡å®™", cx, cy-10);
                ctx.font='700 10px Orbitron'; ctx.fillText("M I N D V E R S E", cx, cy+15);
            }

            // è¡Œæ˜Ÿ
            const nodes = ['BIG5','ANIMAL','MBTI','ENNEAGRAM','RIASEC','COLOR']; 
            nodes.forEach((id, i) => {
                const n = styles.nodes[id];
                const ang=(i/6)*Math.PI*2+lobbyRot; 
                const nx=cx+Math.cos(ang)*r; const ny=cy+Math.sin(ang)*r;
                
                // ç¹ªè£½æ˜Ÿçƒ Icon
                ctx.save(); ctx.translate(nx, ny);
                ctx.shadowColor=n.glow; ctx.shadowBlur=20; ctx.fillStyle='rgba(10,10,20,0.8)'; ctx.beginPath(); ctx.arc(0,0,50,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=0; ctx.strokeStyle=n.color; ctx.lineWidth=2; ctx.stroke();
                // ç°¡å–®åœ–å½¢ç¤ºæ„
                ctx.fillStyle=n.color; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
                ctx.restore();

                // æ¨™é¡Œèˆ‡å‰¯æ¨™é¡Œ (Phase 1: é¦–é å„ªåŒ–)
                ctx.fillStyle = '#fff'; ctx.font = 'bold 16px "Noto Sans TC"'; ctx.textAlign='center';
                ctx.fillText(n.label, nx, ny+70);
                ctx.fillStyle = '#aaa'; ctx.font = '12px "Noto Sans TC"';
                ctx.fillText(n.sub, nx, ny+90);

                if(camera.zoom<2) hitZones.push({t:'circle', x:nx, y:ny, r:70, action:()=>enterGame(id, nx, ny)});
            });
        }

        function enterGame(id, targetX, targetY) {
            currentScene = 'TRANSITION';
            sendGAEvent('level_start', { level_name: id });
            camera.targetZoom = 5; camera.targetX = targetX - width/2; camera.targetY = targetY - height/2;
            setTimeout(() => {
                if(id==='BIG5') startBig5();
                else if(id==='ANIMAL') startAnimalTest();
                // å…¶ä»–çœç•¥
                currentScene = id; camera.zoom = 1; camera.x = 0; camera.y = 0; 
            }, 1500);
        }
        function returnLobby() { 
            closeSummary();
            currentScene = 'LOBBY'; camera.zoom = 5; camera.targetZoom = 1; camera.x = 0; camera.y = 0; camera.targetX = 0; camera.targetY = 0; 
        }

        // --- GAME 1: BIG 5 ---
        function startBig5() { gameSt.big5 = { idx:0, answers:[], done:false }; }
        function drawBig5() {
            const st = gameSt.big5; const cx = width/2, cy = height/2;
            ctx.fillStyle = 'rgba(10,15,30,0.95)'; ctx.fillRect(0,0,width,height);
            
            if(!st.done) {
                const q = big5Data.qs[st.idx];
                drawTitle("äº”å¤§æ€§æ ¼åˆ†æ", cx, 80, styles.nodes.BIG5.color);
                ctx.fillStyle='#00f3ff'; ctx.font='14px Orbitron'; ctx.textAlign='right'; ctx.fillText(`${st.idx+1}/${big5Data.qs.length}`, width-20, 40);

                ctx.fillStyle='#fff'; ctx.font='24px "Noto Sans TC"'; ctx.textAlign='center';
                wrapText(q.t, cx, cy-50, Math.min(600, width-60), 36);

                // é¸é …æ¸²æŸ“
                const sw = Math.min(300, width-80); const sy = cy+80;
                ctx.fillStyle = '#444'; ctx.fillRect(cx-sw/2, sy, sw, 4);
                // é è¨­é¸ä¸­é–“(3)æˆ–ä½¿ç”¨ä¸Šæ¬¡ç´€éŒ„
                let currentAns = st.answers[st.idx] || 3; 
                
                // æ»‘å‹•æ¢é‚è¼¯
                const hx = cx - sw/2 + (sw * (currentAns-1)/4);
                hitZones.push({
                    t:'rect', x:cx-sw/2-20, y:sy-30, w:sw+40, h:60,
                    action: (mx) => {
                        const ratio = (mx - (cx - sw/2)) / sw;
                        st.answers[st.idx] = Math.max(1, Math.min(5, Math.round(ratio*4+1)));
                    }
                });

                // åˆ»åº¦
                for(let i=0; i<5; i++){
                    let tickX = (cx - sw/2) + (sw * (i/4));
                    ctx.beginPath(); ctx.arc(tickX, sy+2, 4, 0, Math.PI*2); ctx.fillStyle='#666'; ctx.fill();
                }
                const opts = ["ä¸åŒæ„", "ç¨ä¸åŒæ„", "æ™®é€š", "ç¨åŒæ„", "åŒæ„"];
                ctx.font = '12px "Noto Sans TC"'; ctx.fillStyle = '#aaa';
                for(let i=0; i<5; i++) ctx.fillText(opts[i], (cx - sw/2) + (sw * (i/4)), sy + 30);

                // æ¸¸æ¨™
                ctx.beginPath(); ctx.arc(hx, sy+2, 12, 0, Math.PI*2); ctx.fillStyle='#00f3ff'; ctx.fill();

                // Phase 0: ä¸Šä¸€é¡Œ/ä¸‹ä¸€é¡ŒæŒ‰éˆ•
                const btnY = height - SAFE_BOTTOM;
                if(st.idx > 0) {
                    drawBtn(cx - 80, btnY, "ä¸Šä¸€é¡Œ", '#444', () => st.idx--, 120);
                }
                drawBtn(st.idx>0 ? cx+80 : cx, btnY, "ä¸‹ä¸€é¡Œ", styles.nodes.BIG5.color, () => {
                    // ç¢ºä¿æœ‰å€¼
                    if(!st.answers[st.idx]) st.answers[st.idx] = 3;
                    if(st.idx < big5Data.qs.length-1) st.idx++;
                    else {
                        st.done = true;
                        finishBig5();
                    }
                }, 120);
            }
        }
        
        function finishBig5() {
            const st = gameSt.big5;
            let scores = {O:0, C:0, E:0, A:0, N:0};
            big5Data.qs.forEach((q, i) => {
                const ans = st.answers[i];
                const sc = ans - 3;
                scores[q.k] += q.rev ? -sc : sc;
            });
            // æ‰¾å‡ºæœ€é«˜åˆ†ç‰¹è³ª
            let maxK='O', maxV=-99;
            for(let k in scores) if(scores[k]>maxV) { maxV=scores[k]; maxK=k; }
            
            // å„²å­˜çµæœ
            userResults.completed.push('BIG5');
            userResults.data['BIG5'] = { type: maxK, scores: scores, detail: big5Data.results[maxK] };
            
            showSummary('BIG5');
        }

        // --- GAME 2: ANIMAL (Phase 1 Logic) ---
        function startAnimalTest() { gameSt.animal = { idx:0, answers:[], done:false }; }
        function drawAnimalTest() {
            const st = gameSt.animal; const cx=width/2, cy=height/2;
            ctx.fillStyle='#051105'; ctx.fillRect(0,0,width,height);
            
            if(!st.done) {
                const q = animalData.qs[st.idx];
                drawTitle("å‹•ç‰©åœ–é¨°", cx, 80, '#32cd32');
                ctx.fillStyle='#fff'; ctx.font='24px "Noto Sans TC"'; ctx.textAlign='center';
                wrapText(q.q, cx, cy-80, width-60, 36);

                const btnW = isMobile ? width-60 : 300;
                drawBtn(cx, cy+20, q.a, '#32cd32', ()=>{ st.answers[st.idx]=1; nextAnimal(); }, btnW);
                drawBtn(cx, cy+90, q.b, '#555', ()=>{ st.answers[st.idx]=-1; nextAnimal(); }, btnW);

                if(st.idx > 0) drawBtn(cx, height-SAFE_BOTTOM, "ä¸Šä¸€é¡Œ", '#333', ()=>st.idx--, 120);
            }
        }
        function nextAnimal() {
            const st = gameSt.animal;
            if(st.idx < animalData.qs.length-1) st.idx++;
            else {
                st.done = true;
                finishAnimal();
            }
        }
        function finishAnimal() {
            const st = gameSt.animal;
            let pos = {x:0, y:0};
            animalData.qs.forEach((q, i) => {
                const v = st.answers[i] * q.v; // q.v is -1, ans is 1 or -1
                pos[q.ax] += v;
            });
            let type = 'D'; // Tiger
            if(pos.x>0 && pos.y<=0) type='I'; // Peacock
            else if(pos.x>0 && pos.y>0) type='S'; // Koala
            else if(pos.x<=0 && pos.y>0) type='C'; // Owl
            
            userResults.completed.push('ANIMAL');
            userResults.data['ANIMAL'] = { type: type, detail: animalData.results[type] };
            
            showSummary('ANIMAL');
        }

        // ==================================================
        // Phase 1: Logic Engine (ä¸»å°åˆ¤å®š & æ•´åˆæ•˜äº‹)
        // ==================================================

        function getPrimaryResult(currentTestId) {
            // ä¿®æ­£é» 1: å„ªå…ˆç´šåˆ¤å®š
            // çµæ§‹å‹ (Big5) > æŠ•å°„å‹ (Animal)
            // è‹¥æœ‰ Big5 è³‡æ–™ï¼Œæ°¸é ä»¥ Big5 ç‚ºä¸»å°ï¼Œé™¤éåªåšäº† Animal
            if (userResults.data['BIG5']) return { source: 'BIG5', ...userResults.data['BIG5'] };
            // è‹¥æœ‰ Enneagram (æ­¤è™•çœç•¥)ï¼Œå‰‡ Enneagram
            // æœ€å¾Œæ‰ fallback åˆ°ç•¶å‰æ¸¬é©—
            if (userResults.data[currentTestId]) return { source: currentTestId, ...userResults.data[currentTestId] };
            return null;
        }

        // éœæ…‹è¦å‰‡è¡¨ (ä¿®æ­£é» 2: æ¨¡æ¿è¦å‰‡)
        const conflictRules = [
            {
                check: (p) => p.animal === 'D' && p.big5 === 'A', // è€è™ + é«˜è¦ªå’Œ
                msg: "ä½ å¤–è¡¨çœ‹ä¼¼æœæ–·å¼·å‹¢ï¼ˆè€è™ï¼‰ï¼Œä½†å…§å¿ƒå…¶å¯¦éå¸¸åœ¨æ„åœ˜éšŠå’Œè«§ï¼ˆè¦ªå’Œï¼‰ã€‚é€™ä¸æ˜¯çŸ›ç›¾ï¼Œä»£è¡¨ä½ æ˜¯ã€Œå¸¶æœ‰æº«åº¦çš„é ˜å°è€…ã€ã€‚"
            },
            {
                check: (p) => p.big5 === 'C' && p.big5_o_score > 0, // é«˜ç›¡è²¬ + é«˜é–‹æ”¾
                msg: "ä½ æ—¢æœ‰å¤©é¦¬è¡Œç©ºçš„å‰µæ„ï¼ˆé–‹æ”¾ï¼‰ï¼Œåˆæœ‰è¶…å¼·çš„åŸ·è¡ŒåŠ›ï¼ˆç›¡è²¬ï¼‰ã€‚ä½ æ˜¯æœ€é©åˆå°‡å‰µæ„è½åœ°çš„ã€Œå¯¦è¸å®¶ã€ã€‚"
            }
        ];

        function getConflictMsg(primary, animalRes) {
            // ç°¡å–®ç¯„ä¾‹ï¼šæª¢æŸ¥è¦å‰‡
            let msg = "ä½ çš„å¿ƒç†èƒ½é‡ç”±å¤šç¨®ç‰¹è³ªäº¤ç¹”è€Œæˆï¼Œåœ¨ä¸åŒæƒ…å¢ƒä¸‹æœƒåˆ‡æ›ä¸åŒæ¨¡å¼ã€‚";
            if (primary.source === 'BIG5' && animalRes) {
                // æ¨¡æ“¬æª¢æŸ¥
                const p = { big5: primary.type, animal: animalRes.type };
                const rule = conflictRules.find(r => r.check(p));
                if(rule) msg = rule.msg;
            }
            return msg;
        }

        // ==================================================
        // Phase 0 & 1: Result Overlay æ¸²æŸ“
        // ==================================================

        function showSummary(currentTestId) {
            const overlay = document.getElementById('resultOverlay');
            const container = document.getElementById('summaryContent');
            
            const primary = getPrimaryResult(currentTestId);
            const detail = primary.detail;
            const animalRes = userResults.data['ANIMAL']; // ç”¨æ–¼è£œå……

            // ç”Ÿæˆ HTML (ä¿®æ­£é» 3: å®Œæ•´çµæ§‹)
            let html = `
                <div class="summary-header">
                    <span class="result-icon">${detail.e || 'âœ¨'}</span>
                    <div class="result-title">${detail.t}</div>
                    <div class="result-subtitle">ä¸»å°å¿ƒç†èƒ½é‡</div>
                    <p class="result-desc">${detail.oneLine || detail.desc}</p>
                </div>

                <div class="section-card">
                    <div class="section-title">ğŸŒŒ å¿ƒç†å®‡å®™è¼ªå»“</div>
                    <div class="text-body">
                        ${getConflictMsg(primary, animalRes)}
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-title">ğŸ› ï¸ é©åˆçš„å·¥ä½œæ–¹å¼</div>
                    <div class="text-body">
                        ${detail.workStyle}
                    </div>
                </div>

                <div class="section-card" style="border-color: rgba(255, 100, 100, 0.3);">
                    <div class="section-title" style="color: #ff8888;">âš ï¸ å®¹æ˜“æ¶ˆè€—ä½ çš„æƒ…å¢ƒ</div>
                    <div class="text-body">
                        ${detail.drain}
                    </div>
                </div>

                <div class="cta-section">
                    <div class="section-title" style="justify-content: center;">ğŸ‘‰ å»¶ä¼¸æ¢ç´¢ä½ çš„è·æ¶¯æ–¹å‘</div>
                    <p class="text-body" style="margin-bottom: 20px; text-align: center;">
                        ä½ å·²ç¶“æ›´äº†è§£è‡ªå·±çš„å¿ƒç†é‹ä½œæ–¹å¼ï¼Œä¸‹ä¸€æ­¥ï¼Œæ˜¯æŠŠé€™äº›ç‰¹è³ªç”¨åœ¨å°çš„åœ°æ–¹ã€‚
                    </p>
                    
                    <a href="https://jobus.asia/topics/personality" target="_blank" class="cta-btn primary">
                        ğŸ§  çœ‹æ‡‚é€™é¡äººæ ¼ï¼Œè·æ¶¯æ€éº¼èµ°
                    </a>
                    <a href="https://jobus.asia/topics/career-strategy" target="_blank" class="cta-btn secondary">
                        ğŸš€ é©åˆæˆ‘çš„è·æ¶¯ç­–ç•¥
                    </a>
                    <button onclick="shareResult('${detail.t}')" class="cta-btn secondary">
                        ğŸ“¤ åˆ†äº«æˆ‘çš„å¿ƒç†å®‡å®™
                    </button>
                </div>
            `;

            container.innerHTML = html;
            overlay.classList.add('visible');
        }

        function closeSummary() {
            document.getElementById('resultOverlay').classList.remove('visible');
            // è¿”å›å¤§å»³é‚è¼¯
            currentScene = 'LOBBY'; camera.zoom = 5; camera.targetZoom = 1;
        }

        // --- Phase 2: Share Fallback (ä¿®æ­£é» 5) ---
        function shareResult(title) {
            const shareData = {
                title: 'æˆ‘çš„å¿ƒç†å®‡å®™ Mindverse',
                text: `æˆ‘åœ¨å¿ƒç†å®‡å®™æ¸¬å‡ºäº†ã€Œ${title}ã€ï¼åŸä¾†é€™å°±æ˜¯æˆ‘å·¥ä½œå¡é—œçš„åŸå› ... ğŸ‘‰`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData).catch(console.error);
            } else {
                alert("é›»è…¦ç‰ˆè«‹ç›´æ¥è¤‡è£½é€£çµåˆ†äº«ï¼\n\n" + shareData.text + "\n" + shareData.url);
            }
        }

        // å•Ÿå‹•
        init();
        loop();

    </script>
</body>
</html>