<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç›´è¦ºå¯¦é©—å®¤ - v4.6</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LH8TP88B66"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LH8TP88B66');
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            height: 100dvh;
            width: 100vw;
        }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        .slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
        .pulse-text { animation: pulseText 2s infinite; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulseText { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.98); } }

        input[type=range] { touch-action: none; -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 48px; width: 48px; border-radius: 50%; background: #ffffff; cursor: pointer; border: 6px solid #4F46E5; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); margin-top: -20px; position: relative; z-index: 20; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 12px; cursor: pointer; background: transparent; border-radius: 10px; }
        
        .category-card:active { transform: scale(0.98); transition: transform 0.1s; }
    </style>
</head>
<body class="flex justify-center items-center overflow-hidden">

    <div id="app" class="w-full h-full sm:max-w-[420px] sm:h-auto sm:max-h-[90vh] bg-white relative sm:shadow-2xl flex flex-col overflow-hidden sm:rounded-[2.5rem] transition-all duration-300">
    </div>

<script>
const WORKER_URL = "https://prediction-game-api.giyin2005.workers.dev/"; 

const DataService = {
    categories: {
        WORKPLACE: [
            { id: "wp_01", displayTitle: "é€™å€‹å°ˆæ¡ˆçœŸçš„æœƒæº–æ™‚ä¸Šç·šå—ï¼Ÿ", introText: "è€é—†èªª Q3 ä¸€å®šè¦ç™¼å¸ƒï¼Œä¾ä½ çš„ç¶“é©—ï¼Œé€™ä»¶äº‹æˆçœŸçš„æ©Ÿç‡æ˜¯ï¼Ÿ", marketType: "EVENT" },
            { id: "wp_02", displayTitle: "å…¬å¸å®£ä½ˆçš„ã€Œæ–°ç¦åˆ©æ”¿ç­–ã€æ˜å¹´é‚„æœƒåœ¨å—ï¼Ÿ", introText: "ä½ è¦ºå¾—é€™æ˜¯ä¸€å€‹é•·æœŸæ‰¿è«¾ï¼Œé‚„æ˜¯é›·è²å¤§é›¨é»å°ï¼Ÿ", marketType: "STABLE" },
            { id: "wp_03", displayTitle: "åŸæœ¬æ‰¿è«¾çš„æ–°åŠŸèƒ½ï¼Œå¹´åº•å‰çœŸçš„åšå¾—å®Œå—ï¼Ÿ", introText: "çœ‹è‘—ç¾åœ¨çš„é€²åº¦æ¢ï¼Œä½ è¦ºå¾—å·¥ç¨‹åœ˜éšŠèƒ½æº–æ™‚äº¤ä»˜å—ï¼Ÿ", marketType: "EVENT" },
            { id: "wp_04", displayTitle: "è¾¦å…¬å®¤é—œæ–¼ã€Œäººäº‹å‡çµã€çš„å‚³èæ˜¯çœŸçš„å—ï¼Ÿ", introText: "æ ¹æ“šä½ çš„è§€å¯Ÿï¼Œå…¬å¸ç›®å‰çš„äººåŠ›ç­–ç•¥å‚¾å‘æ˜¯ï¼Ÿ", marketType: "STABLE" },
            { id: "wp_05", displayTitle: "ä»Šå¹´çš„å¹´çµ‚çé‡‘ï¼Œæœƒæ¯”å»å¹´å¥½å—ï¼Ÿ", introText: "çœ‹è‘—è²¡å ±å’Œè€é—†çš„è‡‰è‰²ï¼Œä½ å¿ƒè£¡çš„é æœŸæ˜¯ï¼Ÿ", marketType: "STABLE" }
        ],
        INVEST: [
            { id: "inv_01", displayTitle: "æ¯”ç‰¹å¹£ä»Šå¹´åº•æœƒçªç ´ 10 è¬ç¾é‡‘å—ï¼Ÿ", introText: "å¸‚å ´æƒ…ç·’æ¥µåº¦è²ªå©ªï¼Œä½ çš„ç†æ€§å‘Šè¨´ä½ æœƒç™¼ç”Ÿå—ï¼Ÿ", marketType: "VOLATILE" },
            { id: "inv_02", displayTitle: "é€™å®¶å…¬å¸çš„è‚¡åƒ¹ï¼Œä¸‹å€‹æœˆæœƒå‰µæ–°é«˜å—ï¼Ÿ", introText: "æŠ€è¡“ç·šåœ–çœ‹èµ·ä¾†å¾ˆå¼·ï¼Œä½†ä½ çš„ç›´è¦ºæ•¢è¿½é«˜å—ï¼Ÿ", marketType: "VOLATILE" },
            { id: "inv_03", displayTitle: "ç¾åœ¨æ˜¯è²·é€²é»ƒé‡‘çš„å¥½æ™‚æ©Ÿå—ï¼Ÿ", introText: "å…¨çƒå±€å‹¢å‹•ç›ªï¼Œä½ è¦ºå¾—é¿éšªè³‡ç”¢é‚„æœƒæ¼²å—ï¼Ÿ", marketType: "STABLE" },
            { id: "inv_04", displayTitle: "é€™å€‹ç†±é–€çš„è¿·å› å¹£ (Meme Coin) æœƒæ­¸é›¶å—ï¼Ÿ", introText: "é›–ç„¶ç¾åœ¨ç‚’å¾ˆå…‡ï¼Œä½†ä½ è¦ºå¾—å®ƒèƒ½æ´»éä¸‰å€‹æœˆå—ï¼Ÿ", marketType: "VOLATILE" },
            { id: "inv_05", displayTitle: "è¯æº–æœƒä¸‹å­£æœƒé™æ¯æ•‘å¸‚å—ï¼Ÿ", introText: "ç¸½é«”ç¶“æ¿Ÿæ•¸æ“šæ··äº‚ï¼Œä½ è³­å¤®è¡Œæœƒæ€éº¼åšï¼Ÿ", marketType: "STABLE" }
        ],
        LIFE: [
            { id: "life_01", displayTitle: "é€™å°æ˜æ˜Ÿæƒ…ä¾¶ä»Šå¹´æœƒåˆ†æ‰‹å—ï¼Ÿ", introText: "å…«å¦é›œèªŒéƒ½åœ¨å‚³ï¼Œçœ‹ä»–å€‘æœ€è¿‘çš„äº’å‹•ï¼Œä½ è¦ºå¾—å‘¢ï¼Ÿ", marketType: "EVENT" },
            { id: "life_02", displayTitle: "æ˜å¤©çš„å¤©æ°£çœŸçš„æœƒå¦‚é å ±ä¸€æ¨£ä¸‹é›¨å—ï¼Ÿ", introText: "çœ‹è‘—ç¾åœ¨çš„å¤©ç©ºï¼Œä½ è¦ºå¾—æ°£è±¡å±€æº–å—ï¼Ÿ", marketType: "EVENT" },
            { id: "life_03", displayTitle: "é€™éƒ¨æœŸå¾…å·²ä¹…çš„é›»å½±æœƒæ˜¯çˆ›ç‰‡å—ï¼Ÿ", introText: "é å‘Šç‰‡å‰ªå¾—å¾ˆå¥½ï¼Œä½†é€šå¸¸é€™å°±æ˜¯é›·ç‰‡çš„å¾µå…†ï¼Ÿ", marketType: "VOLATILE" },
            { id: "life_04", displayTitle: "ä½ æ”¯æŒçš„çƒéšŠä¸‹ä¸€å ´æœƒè´å—ï¼Ÿ", introText: "å°æ‰‹å¾ˆå¼·ï¼Œä½†ä½ çš„ä¿¡ä»°æœ‰å¤šå …å®šï¼Ÿ", marketType: "EVENT" },
            { id: "life_05", displayTitle: "ä¸‹é€±æ²¹åƒ¹æœƒä¸Šæ¼²å—ï¼Ÿ", introText: "åœ‹éš›å±€å‹¢ä¸ç©©ï¼Œä½ è¦ºå¾—è©²å…ˆå»åŠ æ²¹å—ï¼Ÿ", marketType: "STABLE" }
        ]
    },

    async fetchQuestions(categoryKey) {
        let pool = this.categories[categoryKey] || this.categories.WORKPLACE;
        const playedKey = `played_${categoryKey}`;
        let playedIds = JSON.parse(localStorage.getItem(playedKey) || "[]");
        let available = pool.filter(q => !playedIds.includes(q.id));

        if (available.length < 5) {
            localStorage.removeItem(playedKey);
            available = pool;
            playedIds = [];
        }

        const shuffled = available.sort(() => 0.5 - Math.random()).slice(0, 5);
        const newPlayedIds = [...playedIds, ...shuffled.map(q => q.id)];
        localStorage.setItem(playedKey, JSON.stringify(newPlayedIds));

        let marketPools = null;
        if (WORKER_URL) {
            try {
                const [res] = await Promise.all([
                    fetch(WORKER_URL),
                    new Promise(r => setTimeout(r, 1500)) 
                ]);
                if (res.ok) marketPools = await res.json();
            } catch (e) { console.warn("API Error", e); }
        }

        return shuffled.map(q => {
            let prob = 50;
            if (marketPools && marketPools[q.marketType] && marketPools[q.marketType].length > 0) {
                const p = marketPools[q.marketType];
                prob = p[Math.floor(Math.random() * p.length)];
            } else {
                if (q.marketType === "STABLE") prob = Math.floor(Math.random() * (70 - 30 + 1) + 30);
                else if (q.marketType === "VOLATILE") prob = Math.floor(Math.random() * (90 - 10 + 1) + 10);
                else prob = Math.floor(Math.random() * (85 - 15 + 1) + 15);
            }
            return { ...q, mockMarketProb: prob, categoryLabel: this.getCategoryLabel(categoryKey) };
        });
    },

    getCategoryLabel(key) {
        const map = { WORKPLACE: "è·å ´ç›´è¦º", INVEST: "æŠ•è³‡å‹ç‡", LIFE: "å‘½é‹è¼ªç›¤" };
        return map[key] || "æ¸¬é©—";
    }
};

class GameStore {
    constructor() {
        this.state = {
            view: 'home', questions: [], currentQIndex: 0, userGuess: 50, history: [],
            loadingText: 'æ­£åœ¨åŒæ­¥å¸‚å ´æ•¸æ“š...', selectedCategory: 'WORKPLACE'
        };
        this.listeners = [];
    }
    subscribe(listener) { this.listeners.push(listener); }
    setState(newState, silent = false) { this.state = { ...this.state, ...newState }; if (!silent) this.notify(); }
    notify() { this.listeners.forEach(fn => fn(this.state)); }

    async selectCategory(category) {
        this.setState({ view: 'loading', selectedCategory: category, loadingText: 'æ­£åœ¨é€£ç·š Polymarket è³‡æ–™åº«...' });
        try {
            const data = await DataService.fetchQuestions(category);
            this.setState({ questions: data, view: 'game', currentQIndex: 0, history: [], userGuess: 50 });
        } catch (e) {
            console.error(e);
            alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
            this.setState({ view: 'home' });
        }
    }

    startGame() { this.setState({ view: 'game', userGuess: 50 }); }
    updateGuess(val, silent = false) { this.setState({ userGuess: parseInt(val) }, silent); }
    submitGuess() {
        const { questions, currentQIndex, userGuess, history } = this.state;
        const currentQ = questions[currentQIndex];
        const record = { question: currentQ, user: userGuess, market: currentQ.mockMarketProb, diff: userGuess - currentQ.mockMarketProb };
        this.setState({ history: [...history, record], view: 'reveal' });
    }
    nextQuestion() {
        const { currentQIndex, questions } = this.state;
        if (currentQIndex + 1 < questions.length) {
            this.setState({ currentQIndex: currentQIndex + 1, view: 'game', userGuess: 50 });
        } else {
            this.setState({ view: 'result' });
        }
    }
    goHome() { this.setState({ view: 'home' }); }
}
const store = new GameStore();

const App = document.getElementById('app');
function render(state) {
    App.innerHTML = ''; 
    switch(state.view) {
        case 'home':    App.innerHTML = ViewHome(); break;
        case 'loading': App.innerHTML = ViewLoading(state); break;
        case 'game':    App.innerHTML = ViewGame(state); break;
        case 'reveal':  App.innerHTML = ViewReveal(state); break;
        case 'result':  App.innerHTML = ViewResult(state); break;
    }
    bindEvents(state);
}

function bindEvents(state) {
    if (state.view === 'home') {
        document.getElementById('btn-cat-work').onclick = () => store.selectCategory('WORKPLACE');
        document.getElementById('btn-cat-invest').onclick = () => store.selectCategory('INVEST');
        document.getElementById('btn-cat-life').onclick = () => store.selectCategory('LIFE');
    }
    const slider = document.getElementById('guess-slider');
    if (slider) {
        slider.oninput = (e) => {
            const val = e.target.value;
            store.updateGuess(val, true); 
            const display = document.getElementById('val-display');
            const track = document.getElementById('track-fill');
            const thumb = document.getElementById('thumb-visual');
            if(display) display.innerHTML = `${val}<span class="text-3xl text-indigo-300 ml-1">%</span>`;
            if(track) track.style.width = `${val}%`;
            if(thumb) thumb.style.left = `${val}%`;
        };
    }
    const confirmBtn = document.getElementById('btn-confirm');
    if (confirmBtn) confirmBtn.onclick = () => store.submitGuess();
    const nextBtn = document.getElementById('btn-next');
    if (nextBtn) nextBtn.onclick = () => store.nextQuestion();
    const restartBtn = document.getElementById('btn-restart');
    if (restartBtn) restartBtn.onclick = () => store.goHome();
}

function ViewHome() {
    return `
        <div class="flex flex-col h-full p-8 bg-white relative overflow-hidden fade-in">
            <div class="mt-8 mb-6 flex-shrink-0">
                <span class="inline-block px-3 py-1 bg-gray-900 text-white text-xs font-bold tracking-widest rounded-full mb-4">v4.6 ç©©å®šç‰ˆ</span>
                <h1 class="text-5xl font-black text-gray-900 mb-2 leading-none">ç›´è¦º<br><span class="text-indigo-600">å¯¦é©—å®¤</span></h1>
                <p class="text-gray-500 text-xl font-medium mt-2">è«‹é¸æ“‡ä½ æƒ³æ¸¬è©¦çš„èƒ½åŠ›</p>
            </div>
            <div class="flex-grow flex flex-col gap-4 overflow-y-auto no-scrollbar pb-8">
                <div id="btn-cat-work" class="category-card bg-gray-50 border-2 border-gray-100 rounded-3xl p-6 flex items-center gap-4 cursor-pointer active:bg-gray-200 transition-all">
                    <div class="text-5xl">ğŸ¢</div>
                    <div><h3 class="text-2xl font-bold text-gray-900">è·å ´æ±‚ç”Ÿ</h3><p class="text-gray-500 text-base">æ¸¬è©¦ä½ çš„è·å ´å—…è¦ºèˆ‡å‡é·é‹</p></div>
                </div>
                <div id="btn-cat-invest" class="category-card bg-orange-50 border-2 border-orange-100 rounded-3xl p-6 flex items-center gap-4 cursor-pointer active:bg-orange-100 transition-all">
                    <div class="text-5xl">ğŸ’°</div>
                    <div><h3 class="text-2xl font-bold text-gray-900">è²¡å¯Œå¯†ç¢¼</h3><p class="text-gray-500 text-base">æ¸¬è©¦ä½ çš„æŠ•è³‡å‹ç‡èˆ‡è²¡å•†</p></div>
                </div>
                <div id="btn-cat-life" class="category-card bg-green-50 border-2 border-green-100 rounded-3xl p-6 flex items-center gap-4 cursor-pointer active:bg-green-100 transition-all">
                    <div class="text-5xl">ğŸ€</div>
                    <div><h3 class="text-2xl font-bold text-gray-900">å‘½é‹è¼ªç›¤</h3><p class="text-gray-500 text-base">æ¸¬è©¦ä½ çš„ç¬¬å…­æ„Ÿèˆ‡å¹¸é‹å€¼</p></div>
                </div>
            </div>
            <div class="text-center mt-2 mb-4 flex-shrink-0">
                <p class="text-xs text-gray-500 font-bold flex items-center justify-center gap-2">
                    <span class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                    </span>
                    ç³»çµ±é€£ç·šæ­£å¸¸ | æ•¸æ“šæºï¼šPolymarket
                </p>
            </div>
        </div>
    `;
}

function ViewLoading(state) {
    return `<div class="flex flex-col items-center justify-center h-full space-y-6 bg-gray-50 px-8 rounded-[2.5rem]"><div class="relative"><div class="w-20 h-20 border-[6px] border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div></div><p class="text-gray-600 text-xl animate-pulse tracking-wide font-bold text-center">${state.loadingText}</p></div>`;
}

// v4.6 çµ‚æ¥µä¿®æ­£ï¼šç¸®å°æ•¸å­—å­—é«”ã€å¢åŠ å¼·åˆ¶é–“è·ã€é‡‹æ”¾ç©ºé–“
function ViewGame(state) {
    const q = state.questions[state.currentQIndex];
    const progress = ((state.currentQIndex + 1) / state.questions.length) * 100;
    
    return `
        <div class="flex flex-col h-full bg-gray-50 fade-in relative overflow-hidden">
            <div class="w-full h-2 bg-gray-200 flex-shrink-0"><div class="h-full bg-indigo-600 transition-all duration-500 ease-out" style="width: ${progress}%"></div></div>
            <div class="px-6 pt-6 flex justify-between items-center flex-shrink-0">
                <span class="text-gray-500 text-sm font-bold tracking-widest uppercase">Q ${state.currentQIndex + 1} / ${state.questions.length}</span>
                <span class="text-indigo-600 text-sm font-bold bg-indigo-100 px-3 py-1 rounded-full border border-indigo-200">${q.categoryLabel}</span>
            </div>
            
            <div class="px-6 py-4 flex-shrink-0">
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 slide-in-right">
                    <h2 class="text-2xl font-black text-gray-900 mb-3 leading-tight">${q.displayTitle}</h2>
                    <p class="text-gray-600 text-lg leading-relaxed font-medium">${q.introText}</p>
                </div>
            </div>

            <div class="flex-grow flex flex-col justify-center items-center relative overflow-y-auto no-scrollbar py-2">
                <div class="absolute text-[10rem] font-black text-gray-200 select-none -z-10 opacity-30 transform -rotate-12">%</div>
                
                <div class="text-center w-full max-w-xs relative z-10 my-auto pb-4">
                    <div class="h-4 w-full"></div> 
                    
                    <div class="mb-4 pulse-text flex justify-center items-center text-indigo-600 font-bold bg-indigo-100 inline-block px-5 py-2 rounded-full text-lg mx-auto shadow-sm">
                        <span>ğŸ‘‡ å·¦å³æ»‘å‹•è¼¸å…¥ç›´è¦º</span>
                    </div>
                    
                    <div id="val-display" class="text-6xl font-black text-indigo-600 tracking-tighter mb-6 tabular-nums relative inline-block drop-shadow-sm">
                        ${state.userGuess}<span class="text-3xl text-indigo-300 ml-1">%</span>
                    </div>
                    
                    <div class="relative h-28 w-full flex items-center py-4">
                        <div class="absolute left-0 right-0 top-1/2 h-6 bg-gray-200 rounded-full overflow-hidden transform -translate-y-1/2 pointer-events-none shadow-inner border border-gray-300">
                            <div id="track-fill" class="h-full bg-indigo-500 transition-all duration-150" style="width: ${state.userGuess}%"></div>
                        </div>
                        <input id="guess-slider" type="range" min="0" max="100" value="${state.userGuess}" class="z-10 relative w-full h-full opacity-0 cursor-pointer">
                        <div id="thumb-visual" class="absolute top-1/2 h-14 w-14 bg-white border-[6px] border-indigo-600 rounded-full shadow-[0_4px_16px_rgba(79,70,229,0.5)] transform -translate-y-1/2 -translate-x-1/2 pointer-events-none transition-all duration-150 flex items-center justify-center" style="left: ${state.userGuess}%">
                            <div class="w-4 h-4 bg-indigo-600 rounded-full"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-base font-bold text-gray-400 mt-2 px-2">
                        <span>0% ä¸å¯èƒ½</span><span>100% çµ•å°æœƒ</span>
                    </div>
                </div>
            </div>
            
            <div class="p-6 pt-4 bg-gray-50 border-t border-gray-200 flex-shrink-0 z-20">
                <button id="btn-confirm" class="w-full bg-gray-900 text-white text-2xl font-bold py-5 rounded-[2rem] shadow-xl transform transition active:scale-[0.98] hover:bg-gray-800 flex justify-center items-center gap-3 active:shadow-md">
                    ç¢ºèªé–å®š <span class="text-xl opacity-60">ğŸ”’</span>
                </button>
            </div>
        </div>
    `;
}

function ViewReveal(state) {
    const lastRecord = state.history[state.history.length - 1];
    const q = lastRecord.question;
    const userVal = lastRecord.user;
    const marketVal = lastRecord.market;
    let diffText = Math.abs(diff = userVal - marketVal) < 10 ? "è‹±é›„æ‰€è¦‹ç•¥åŒ" : (diff > 0 ? "ä½ æ¯”å¸‚å ´æ›´æ¨‚è§€" : "ä½ æ¯”å¸‚å ´æ›´ä¿å®ˆ");
    const diffColorClass = diff > 0 ? "text-orange-400" : "text-blue-400";
    const diffBgClass = diff > 0 ? "bg-orange-500" : "bg-blue-500";
    
    return `
        <div class="flex flex-col h-full bg-gray-900 text-white slide-up relative overflow-hidden">
            <div class="absolute top-0 right-0 w-80 h-80 bg-indigo-600 rounded-full mix-blend-multiply filter blur-3xl opacity-25 -mr-20 -mt-20 animate-pulse"></div>
            
            <div class="flex-grow overflow-y-auto px-8 pt-10 pb-10 scroll-smooth no-scrollbar relative z-10">
                <h3 class="text-indigo-400 text-sm font-bold uppercase tracking-widest mb-3">${q.categoryLabel}</h3>
                <h2 class="text-2xl font-black mb-12 leading-tight text-white/95">${q.displayTitle}</h2>
                <div class="space-y-12">
                    <div>
                        <div class="flex justify-between items-end mb-4"><span class="text-xl text-indigo-300 font-bold">ä½ çš„ç›´è¦º</span><span class="text-6xl font-black text-white leading-none tracking-tighter">${userVal}%</span></div>
                        <div class="h-5 bg-gray-800/50 rounded-full overflow-hidden border border-gray-700/50"><div class="h-full bg-indigo-500 rounded-full transition-all duration-1000 ease-out shadow-[0_0_12px_rgba(99,102,241,0.6)]" style="width: ${userVal}%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-end mb-4">
                            <div class="flex flex-col"><span class="text-xl text-emerald-300 font-bold mb-1">å¸‚å ´å…±è­˜</span><span class="inline-block self-start text-xs bg-gray-800/80 border border-gray-700 px-3 py-1 rounded-full text-gray-400 tracking-wider font-medium">å³æ™‚æ•¸æ“š</span></div>
                            <span class="text-6xl font-black text-emerald-400 leading-none tracking-tighter">${marketVal}%</span>
                        </div>
                        <div class="h-5 bg-gray-800/50 rounded-full overflow-hidden border border-gray-700/50"><div class="h-full bg-emerald-500 rounded-full transition-all duration-1000 ease-out shadow-[0_0_12px_rgba(52,211,153,0.6)]" style="width: ${marketVal}%"></div></div>
                    </div>
                </div>
                <div class="mt-16 text-center">
                    <div class="inline-block px-8 py-6 bg-gray-800/60 backdrop-blur-md border border-gray-700/50 rounded-3xl shadow-2xl">
                        <span class="text-3xl font-black text-gray-100 block mb-2">${diffText}</span>
                        <span class="text-xl ${diffColorClass} font-bold tracking-wider flex items-center justify-center gap-2"><span class="inline-block w-3 h-3 rounded-full ${diffBgClass}"></span>å·®ç•° ${diff > 0 ? '+' : ''}${diff}%</span>
                    </div>
                </div>
            </div>
            
            <div class="p-6 pt-6 bg-gray-900 border-t border-gray-800 flex-shrink-0 z-20">
                <button id="btn-next" class="w-full bg-white text-gray-900 text-2xl font-bold py-6 rounded-[2rem] shadow-xl transform transition active:scale-[0.98] hover:bg-gray-200 active:shadow-md">ä¸‹ä¸€é¡Œ â†’</button>
            </div>
        </div>
    `;
}

function ViewResult(state) {
    const totalDiff = state.history.reduce((acc, curr) => acc + curr.diff, 0);
    const avgDiff = totalDiff / state.history.length;
    const totalAbsDiff = state.history.reduce((acc, curr) => acc + Math.abs(curr.diff), 0);
    const avgAbsDiff = totalAbsDiff / state.history.length;
    
    const biasValue = avgDiff > 0 ? `æ¯”å¤§çœ¾æ¨‚è§€ ${Math.round(avgDiff)}%` : (avgDiff < 0 ? `æ¯”å¤§çœ¾ä¿å®ˆ ${Math.round(Math.abs(avgDiff))}%` : "èˆ‡å¤§çœ¾å®Œå…¨ä¸€è‡´");
    let volValue = "";
    if (avgAbsDiff < 15) volValue = `${Math.round(avgAbsDiff)}% (èˆ‡å¤§çœ¾å·®ä¸å¤š)`;
    else if (avgAbsDiff < 30) volValue = `${Math.round(avgAbsDiff)}% (æœ‰é»ç¨ç‰¹)`;
    else volValue = `${Math.round(avgAbsDiff)}% (éå¸¸ç¨ç‰¹)`;

    let persona = {};
    if (avgAbsDiff < 15) { 
        persona = { img: "https://api.dicebear.com/9.x/micah/svg?seed=Felix&backgroundColor=e0e7ff", title: "äººé–“æ¸…é†’", titleEn: "The Sober Realist", color: "text-indigo-600", tag: "ç²¾æº–åŒæ­¥", desc: "ä½ ä¸æ˜¯æ™®é€šï¼Œä½ æ˜¯ã€Œç²¾æº–ã€ã€‚<br>é€™ä»£è¡¨ä½ å°å±€å‹¢çš„åˆ¤æ–·èˆ‡é›†é«”æ™ºæ…§ (Wisdom of Crowd) é«˜åº¦é‡ç–Šã€‚åœ¨çœ¾äººçš†é†‰çš„è·å ´è£¡ï¼Œä½ å°±æ˜¯é‚£å€‹å”¯ä¸€çœ‹æ¸…ç¾å¯¦ã€èƒ½å®¢è§€è©•ä¼°é¢¨éšªçš„äººã€‚", advice: "ğŸ’¡ <b>ä½ çš„å„ªå‹¢ï¼š</b>ä½ æ˜¯åœ˜éšŠçš„ã€Œå®šæµ·ç¥é‡ã€ã€‚<br>ç•¶å¤§å®¶æ„è¦‹åˆ†æ­§æ™‚ï¼Œä½ çš„ç›´è¦ºé€šå¸¸å°±æ˜¯æœ€æ¥è¿‘äº‹å¯¦çš„ç­”æ¡ˆã€‚è«‹æ›´æœ‰è‡ªä¿¡åœ°ç«™å‡ºä¾†çµ±åˆæ„è¦‹ã€‚" };
    } else if (avgDiff >= 15) { 
        persona = { img: "https://api.dicebear.com/9.x/notionists/svg?seed=Rocket&backgroundColor=ffedd5", title: "æ©Ÿé‡çµäºº", titleEn: "The Opportunity Hunter", color: "text-orange-500", tag: "é–‹å‰µå‹", desc: "ä½ çœ‹åˆ°çš„æœªä¾†ï¼Œæ¯”å¤§éƒ¨åˆ†äººæ›´å…‰æ˜ã€‚ä½ å°æ–¼ã€Œå¯èƒ½æ€§ã€éå¸¸æ•æ„Ÿï¼Œé€™è®“ä½ æˆç‚ºæ¥µä½³çš„æ¥­å‹™æˆ–ç”¢å“é–‹å‰µè€…ï¼Œå› ç‚ºä½ ç¸½èƒ½çœ‹è¦‹åˆ¥äººçœ‹ä¸è¦‹çš„æ©Ÿæœƒã€‚", advice: "ğŸ’¡ <b>ä½ çš„å„ªå‹¢ï¼š</b>ä½ æ•¢åšå¤¢ï¼Œä¹Ÿæ•¢è¡ã€‚<br>ä½ éœ€è¦é…ä¸€å€‹<b>èƒ½éš¨æ™‚æ‹‰ä½ å›ç¾å¯¦</b>çš„ç†æ€§å‰¯æ‰‹ã€‚ç•¶ä½ èªªã€Œä¸‹é€±å¯ä»¥ä¸Šç·šã€æ™‚ï¼Œè®“ä»–å¹«ä½ æª¢æŸ¥æ˜¯ä¸æ˜¯æ¼äº†ä»€éº¼ç´°ç¯€ã€‚" };
    } else if (avgDiff <= -15) { 
        persona = { img: "https://api.dicebear.com/9.x/notionists/svg?seed=Shield&backgroundColor=ccfbf1", title: "é¢¨éšªå®ˆé–€å“¡", titleEn: "The Risk Guardian", color: "text-teal-600", tag: "é˜²ç¦¦å‹", desc: "ä½ æ¯”å¸‚å ´æ›´è¬¹æ…ï¼Œé€™ä¸æ˜¯å£äº‹ã€‚ä½ æ“æœ‰æ¥µå¼·çš„ã€Œå±æ©Ÿå—…è¦ºã€ï¼Œå¾€å¾€åœ¨å°ˆæ¡ˆé‚„æ²’é–‹å§‹å‰ï¼Œä½ å°±å·²ç¶“èåˆ°äº†ç‡’ç„¦å‘³ã€‚ä½ æ˜¯é˜²æ­¢å…¬å¸ç¿»è»Šçš„é—œéµç…è»Šçš®ã€‚", advice: "ğŸ’¡ <b>ä½ çš„å„ªå‹¢ï¼š</b>ä½ ä¸æœƒè®“åœ˜éšŠé™·å…¥çµ•å¢ƒã€‚<br>å°å¿ƒåˆ¥è®Šæˆã€Œæ°£æ°›æ®ºæ‰‹ã€ã€‚è©¦è‘—æŠŠã€Œæˆ‘è¦ºå¾—ä¸è¡Œã€æ”¹æˆã€Œå¦‚æœæˆ‘å€‘è¦æˆåŠŸï¼Œå¿…é ˆå…ˆè§£æ±ºé€™ä¸‰å€‹éš±æ†‚...ã€ã€‚" };
    } else {
        persona = { img: "https://api.dicebear.com/9.x/notionists/svg?seed=Magic&backgroundColor=f3e8ff", title: "ç›´è¦ºç¨è¡Œä¿ ", titleEn: "The Intuitive Maverick", color: "text-purple-600", tag: "ç¨ç«‹æ€è€ƒ", desc: "ä½ çš„åˆ¤æ–·å®Œå…¨ä¸éš¨æ³¢é€æµã€‚<br>æœ‰æ™‚ä½ æ¯”å¸‚å ´æ¥µåº¦æ¨‚è§€ï¼Œæœ‰æ™‚åˆæ¥µåº¦ä¿å®ˆã€‚é€™ä»£è¡¨ä½ æ“æœ‰éå¸¸ç¨ç‰¹çš„è¦–è§’ï¼Œä¸å—ç¾¤é«”å…±è­˜å½±éŸ¿ï¼Œæ˜¯æ¨™æº–çš„ã€Œåå‘æ“ä½œã€æ½›åŠ›è‚¡ã€‚", advice: "ğŸ’¡ <b>ä½ çš„å„ªå‹¢ï¼š</b>ä½ çœ‹è¦‹äº†åˆ¥äººæ²’çœ‹è¦‹çš„ç›²é»ã€‚<br>ä½ çš„è§€é»é€šå¸¸å¾ˆæœ‰è¡æ“Šæ€§ï¼Œå»ºè­°åœ¨ç™¼è¡¨æ„è¦‹æ™‚å¤šæº–å‚™ä¸€äº›æ•¸æ“šä½è­‰ï¼Œå› ç‚ºä½ çš„ç›´è¦ºå°å¤§å¤šæ•¸äººä¾†èªªå¯èƒ½å¤ªéå‰è¡›ã€‚" };
    }

    return `
        <div class="flex flex-col h-full bg-white relative fade-in overflow-hidden">
            <div class="flex-grow overflow-y-auto px-6 pt-6 pb-48 scroll-smooth no-scrollbar relative z-10">
                <div class="text-center">
                    <p class="text-gray-400 text-sm font-bold tracking-[0.3em] uppercase mb-8">â€” ä½ çš„ç›´è¦ºåˆ†æå ±å‘Š â€”</p>
                    <div class="bg-gray-50 rounded-[3rem] p-8 mb-10 border-2 border-gray-100 shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-gray-200/50 rounded-full mix-blend-multiply filter blur-3xl opacity-50 -mr-20 -mt-20"></div>
                        <div class="relative z-10">
                            <div class="mb-10 mx-auto w-48 h-48 relative">
                                <div class="absolute inset-0 bg-white/80 rounded-full animate-pulse shadow-[0_0_30px_rgba(0,0,0,0.05)]"></div>
                                <img src="${persona.img}" alt="${persona.title}" class="relative z-10 w-full h-full rounded-full shadow-2xl border-[6px] border-white object-cover">
                            </div>
                            <span class="inline-block px-6 py-2.5 bg-white border-2 border-gray-200 text-gray-700 text-base font-bold tracking-wider rounded-full mb-6 shadow-md uppercase">${persona.tag}</span>
                            <h2 class="text-6xl font-black mb-3 ${persona.color} leading-tight tracking-tight">${persona.title}</h2>
                            <p class="text-gray-400 text-xl font-bold uppercase tracking-widest mb-10 opacity-80">${persona.titleEn}</p>
                            <div class="w-24 h-2 bg-gray-200 mx-auto rounded-full mb-10"></div>
                            <p class="text-gray-700 text-[1.35rem] leading-relaxed text-justify mb-6 tracking-wide font-medium">${persona.desc}</p>
                        </div>
                    </div>
                    <div class="bg-indigo-50 p-10 rounded-[2.5rem] border-l-[12px] border-indigo-500 text-left mb-12 shadow-md">
                        <p class="text-indigo-900 text-2xl font-bold leading-relaxed">${persona.advice}</p>
                    </div>
                    <div class="space-y-6 px-4 mb-8">
                        <h3 class="text-xl font-bold text-gray-400 uppercase tracking-wider border-b-2 border-gray-200 pb-4 text-left mb-8">æ•¸æ“šé«”æª¢</h3>
                        <div class="flex flex-col gap-3 mb-8"><div class="flex justify-between items-center"><span class="text-gray-700 text-2xl font-bold">ä½ çœ‹äº‹æƒ…æœ‰å¤šæ¨‚è§€ï¼Ÿ</span></div><span class="block w-fit ml-auto bg-gray-100 text-gray-900 px-6 py-3 rounded-2xl text-right font-black text-4xl shadow-sm tracking-tight border border-gray-200">${biasValue}</span></div>
                        <div class="flex flex-col gap-3"><div class="flex justify-between items-center"><span class="text-gray-700 text-2xl font-bold">ä½ çš„è§€é»æœ‰å¤šç¨ç‰¹ï¼Ÿ</span></div><span class="block w-fit ml-auto bg-gray-100 text-gray-800 px-6 py-3 rounded-2xl text-right font-bold text-3xl shadow-sm border border-gray-200">${volValue}</span></div>
                    </div>
                </div>
            </div>
            
            <div class="absolute bottom-0 left-0 right-0 z-20 pointer-events-none">
                <div class="h-64 bg-gradient-to-t from-white via-white/98 to-transparent flex flex-col justify-end items-center p-6 pb-12">
                    <div class="flex flex-col items-center mb-6 animate-bounce opacity-70">
                        <span class="text-sm font-bold text-gray-400 tracking-widest uppercase mb-1">ä¸‹æ»‘æŸ¥çœ‹å®Œæ•´åˆ†æ</span>
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    </div>
                    <button id="btn-restart" class="w-full bg-gray-900 text-white text-3xl font-bold py-7 rounded-[2.5rem] shadow-2xl transform transition active:scale-[0.98] hover:bg-gray-800 pointer-events-auto active:shadow-lg">å›é¦–é é¸é¡åˆ¥</button>
                </div>
            </div>
        </div>
    `;
}

store.subscribe(render);
render(store.state);
</script>
</body>
</html>